

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>airdrops.protocols.scroll.scroll &mdash; Airdrops Automation API Docs 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../_static/documentation_options.js?v=01f34227"></script>
      <script src="../../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            Airdrops Automation API Docs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../protocols.html">Protocols API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../protocols.html#module-airdrops.protocols">Main Protocols Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../protocols.html#module-airdrops.protocols.hyperliquid">Hyperliquid Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.hyperliquid.stake_rotate"><code class="docutils literal notranslate"><span class="pre">stake_rotate()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.hyperliquid.vault_cycle"><code class="docutils literal notranslate"><span class="pre">vault_cycle()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.hyperliquid.spot_swap"><code class="docutils literal notranslate"><span class="pre">spot_swap()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.hyperliquid.evm_roundtrip"><code class="docutils literal notranslate"><span class="pre">evm_roundtrip()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.hyperliquid.perform_random_onchain"><code class="docutils literal notranslate"><span class="pre">perform_random_onchain()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../protocols.html#module-airdrops.protocols.layerzero">LayerZero Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.layerzero.layerzero.bridge"><code class="docutils literal notranslate"><span class="pre">bridge()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.layerzero.layerzero.perform_random_bridge"><code class="docutils literal notranslate"><span class="pre">perform_random_bridge()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../protocols.html#module-airdrops.protocols.scroll">Scroll Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.scroll.bridge_assets"><code class="docutils literal notranslate"><span class="pre">bridge_assets()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.scroll.swap_tokens"><code class="docutils literal notranslate"><span class="pre">swap_tokens()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.scroll.provide_liquidity_scroll"><code class="docutils literal notranslate"><span class="pre">provide_liquidity_scroll()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.scroll.lend_borrow_layerbank_scroll"><code class="docutils literal notranslate"><span class="pre">lend_borrow_layerbank_scroll()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.scroll.perform_random_activity_scroll"><code class="docutils literal notranslate"><span class="pre">perform_random_activity_scroll()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.ScrollBridgeError"><code class="docutils literal notranslate"><span class="pre">ScrollBridgeError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.InsufficientBalanceError"><code class="docutils literal notranslate"><span class="pre">InsufficientBalanceError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.TransactionRevertedError"><code class="docutils literal notranslate"><span class="pre">TransactionRevertedError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.TransactionRevertedError.__init__"><code class="docutils literal notranslate"><span class="pre">TransactionRevertedError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.RPCError"><code class="docutils literal notranslate"><span class="pre">RPCError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.ApprovalError"><code class="docutils literal notranslate"><span class="pre">ApprovalError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.GasEstimationError"><code class="docutils literal notranslate"><span class="pre">GasEstimationError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.MaxRetriesExceededError"><code class="docutils literal notranslate"><span class="pre">MaxRetriesExceededError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.TransactionBuildError"><code class="docutils literal notranslate"><span class="pre">TransactionBuildError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.TransactionSendError"><code class="docutils literal notranslate"><span class="pre">TransactionSendError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.TransactionReceiptError"><code class="docutils literal notranslate"><span class="pre">TransactionReceiptError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.ScrollValueError"><code class="docutils literal notranslate"><span class="pre">ScrollValueError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.TokenNotSupportedError"><code class="docutils literal notranslate"><span class="pre">TokenNotSupportedError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.ScrollSwapError"><code class="docutils literal notranslate"><span class="pre">ScrollSwapError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.ScrollSwapError.__init__"><code class="docutils literal notranslate"><span class="pre">ScrollSwapError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.InsufficientLiquidityError"><code class="docutils literal notranslate"><span class="pre">InsufficientLiquidityError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.ScrollLendingError"><code class="docutils literal notranslate"><span class="pre">ScrollLendingError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.InsufficientCollateralError"><code class="docutils literal notranslate"><span class="pre">InsufficientCollateralError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.MarketNotEnteredError"><code class="docutils literal notranslate"><span class="pre">MarketNotEnteredError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.RepayAmountExceedsDebtError"><code class="docutils literal notranslate"><span class="pre">RepayAmountExceedsDebtError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.LayerBankComptrollerRejectionError"><code class="docutils literal notranslate"><span class="pre">LayerBankComptrollerRejectionError</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.LayerBankComptrollerRejectionError.__init__"><code class="docutils literal notranslate"><span class="pre">LayerBankComptrollerRejectionError.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.scroll.exceptions.ScrollRandomActivityError"><code class="docutils literal notranslate"><span class="pre">ScrollRandomActivityError</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../protocols.html#module-airdrops.protocols.zksync">zkSync Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.zksync.zksync.bridge_eth"><code class="docutils literal notranslate"><span class="pre">bridge_eth()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.zksync.zksync.swap_tokens"><code class="docutils literal notranslate"><span class="pre">swap_tokens()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.zksync.zksync.lend_borrow"><code class="docutils literal notranslate"><span class="pre">lend_borrow()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.zksync.zksync.perform_random_activity"><code class="docutils literal notranslate"><span class="pre">perform_random_activity()</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../protocols.html#module-airdrops.protocols.eigenlayer">EigenLayer Protocol</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.eigenlayer.restake_lst"><code class="docutils literal notranslate"><span class="pre">restake_lst()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.eigenlayer.DepositCapReachedError"><code class="docutils literal notranslate"><span class="pre">DepositCapReachedError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.eigenlayer.EigenLayerRestakeError"><code class="docutils literal notranslate"><span class="pre">EigenLayerRestakeError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.eigenlayer.UnsupportedLSTError"><code class="docutils literal notranslate"><span class="pre">UnsupportedLSTError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.eigenlayer.eigenlayer.restake_lst"><code class="docutils literal notranslate"><span class="pre">restake_lst()</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.eigenlayer.eigenlayer.UnsupportedLSTError"><code class="docutils literal notranslate"><span class="pre">UnsupportedLSTError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.eigenlayer.eigenlayer.EigenLayerRestakeError"><code class="docutils literal notranslate"><span class="pre">EigenLayerRestakeError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.eigenlayer.eigenlayer.DepositCapReachedError"><code class="docutils literal notranslate"><span class="pre">DepositCapReachedError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.eigenlayer.exceptions.EigenLayerRestakeError"><code class="docutils literal notranslate"><span class="pre">EigenLayerRestakeError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.eigenlayer.exceptions.UnsupportedLSTError"><code class="docutils literal notranslate"><span class="pre">UnsupportedLSTError</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../protocols.html#airdrops.protocols.eigenlayer.exceptions.DepositCapReachedError"><code class="docutils literal notranslate"><span class="pre">DepositCapReachedError</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../scheduler.html">Scheduler API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../scheduler.html#module-airdrops.scheduler">Scheduler Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.CentralScheduler"><code class="docutils literal notranslate"><span class="pre">CentralScheduler</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.CentralScheduler.__init__"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.CentralScheduler.add_job"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.add_job()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.CentralScheduler.handle_task_failure"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.handle_task_failure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.CentralScheduler.manage_task_dependencies"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.manage_task_dependencies()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.CentralScheduler.manage_task_priority"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.manage_task_priority()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.CentralScheduler.schedule_dynamically"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.schedule_dynamically()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.CentralScheduler.start"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.CentralScheduler.stop"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.stop()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../scheduler.html#module-airdrops.scheduler.bot">Scheduler Bot</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskStatus"><code class="docutils literal notranslate"><span class="pre">TaskStatus</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskStatus.PENDING"><code class="docutils literal notranslate"><span class="pre">TaskStatus.PENDING</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskStatus.RUNNING"><code class="docutils literal notranslate"><span class="pre">TaskStatus.RUNNING</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskStatus.COMPLETED"><code class="docutils literal notranslate"><span class="pre">TaskStatus.COMPLETED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskStatus.FAILED"><code class="docutils literal notranslate"><span class="pre">TaskStatus.FAILED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskStatus.RETRYING"><code class="docutils literal notranslate"><span class="pre">TaskStatus.RETRYING</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskStatus.CANCELLED"><code class="docutils literal notranslate"><span class="pre">TaskStatus.CANCELLED</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskPriority"><code class="docutils literal notranslate"><span class="pre">TaskPriority</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskPriority.LOW"><code class="docutils literal notranslate"><span class="pre">TaskPriority.LOW</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskPriority.NORMAL"><code class="docutils literal notranslate"><span class="pre">TaskPriority.NORMAL</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskPriority.HIGH"><code class="docutils literal notranslate"><span class="pre">TaskPriority.HIGH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskPriority.CRITICAL"><code class="docutils literal notranslate"><span class="pre">TaskPriority.CRITICAL</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition"><code class="docutils literal notranslate"><span class="pre">TaskDefinition</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition.task_id"><code class="docutils literal notranslate"><span class="pre">TaskDefinition.task_id</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition.func"><code class="docutils literal notranslate"><span class="pre">TaskDefinition.func</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition.args"><code class="docutils literal notranslate"><span class="pre">TaskDefinition.args</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition.kwargs"><code class="docutils literal notranslate"><span class="pre">TaskDefinition.kwargs</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition.priority"><code class="docutils literal notranslate"><span class="pre">TaskDefinition.priority</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition.dependencies"><code class="docutils literal notranslate"><span class="pre">TaskDefinition.dependencies</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition.max_retries"><code class="docutils literal notranslate"><span class="pre">TaskDefinition.max_retries</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition.retry_delay"><code class="docutils literal notranslate"><span class="pre">TaskDefinition.retry_delay</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition.timeout"><code class="docutils literal notranslate"><span class="pre">TaskDefinition.timeout</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition.metadata"><code class="docutils literal notranslate"><span class="pre">TaskDefinition.metadata</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition.__post_init__"><code class="docutils literal notranslate"><span class="pre">TaskDefinition.__post_init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskDefinition.__init__"><code class="docutils literal notranslate"><span class="pre">TaskDefinition.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskExecution"><code class="docutils literal notranslate"><span class="pre">TaskExecution</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskExecution.task_id"><code class="docutils literal notranslate"><span class="pre">TaskExecution.task_id</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskExecution.status"><code class="docutils literal notranslate"><span class="pre">TaskExecution.status</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskExecution.start_time"><code class="docutils literal notranslate"><span class="pre">TaskExecution.start_time</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskExecution.end_time"><code class="docutils literal notranslate"><span class="pre">TaskExecution.end_time</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskExecution.retry_count"><code class="docutils literal notranslate"><span class="pre">TaskExecution.retry_count</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskExecution.last_error"><code class="docutils literal notranslate"><span class="pre">TaskExecution.last_error</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskExecution.result"><code class="docutils literal notranslate"><span class="pre">TaskExecution.result</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.TaskExecution.__init__"><code class="docutils literal notranslate"><span class="pre">TaskExecution.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.CentralScheduler"><code class="docutils literal notranslate"><span class="pre">CentralScheduler</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.CentralScheduler.__init__"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.CentralScheduler.add_job"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.add_job()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.CentralScheduler.manage_task_priority"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.manage_task_priority()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.CentralScheduler.manage_task_dependencies"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.manage_task_dependencies()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.CentralScheduler.schedule_dynamically"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.schedule_dynamically()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.CentralScheduler.handle_task_failure"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.handle_task_failure()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.CentralScheduler.start"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.CentralScheduler.stop"><code class="docutils literal notranslate"><span class="pre">CentralScheduler.stop()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../scheduler.html#airdrops.scheduler.bot.main"><code class="docutils literal notranslate"><span class="pre">main()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../risk_management.html">Risk Management API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../risk_management.html#risk-management-module">Risk Management Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../risk_management.html#risk-management-core">Risk Management Core</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../capital_allocation.html">Capital Allocation API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../capital_allocation.html#module-airdrops.capital_allocation">Capital Allocation Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.CapitalAllocator"><code class="docutils literal notranslate"><span class="pre">CapitalAllocator</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.CapitalAllocator.__init__"><code class="docutils literal notranslate"><span class="pre">CapitalAllocator.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.CapitalAllocator.allocate_risk_adjusted_capital"><code class="docutils literal notranslate"><span class="pre">CapitalAllocator.allocate_risk_adjusted_capital()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.CapitalAllocator.calculate_efficiency_metrics"><code class="docutils literal notranslate"><span class="pre">CapitalAllocator.calculate_efficiency_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.CapitalAllocator.optimize_portfolio"><code class="docutils literal notranslate"><span class="pre">CapitalAllocator.optimize_portfolio()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.CapitalAllocator.rebalance_portfolio"><code class="docutils literal notranslate"><span class="pre">CapitalAllocator.rebalance_portfolio()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../capital_allocation.html#module-airdrops.capital_allocation.engine">Capital Allocation Engine</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.CapitalAllocator"><code class="docutils literal notranslate"><span class="pre">CapitalAllocator</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.CapitalAllocator.__init__"><code class="docutils literal notranslate"><span class="pre">CapitalAllocator.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.CapitalAllocator.optimize_portfolio"><code class="docutils literal notranslate"><span class="pre">CapitalAllocator.optimize_portfolio()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.CapitalAllocator.allocate_risk_adjusted_capital"><code class="docutils literal notranslate"><span class="pre">CapitalAllocator.allocate_risk_adjusted_capital()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.CapitalAllocator.rebalance_portfolio"><code class="docutils literal notranslate"><span class="pre">CapitalAllocator.rebalance_portfolio()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.CapitalAllocator.calculate_efficiency_metrics"><code class="docutils literal notranslate"><span class="pre">CapitalAllocator.calculate_efficiency_metrics()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.AllocationStrategy"><code class="docutils literal notranslate"><span class="pre">AllocationStrategy</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.AllocationStrategy.EQUAL_WEIGHT"><code class="docutils literal notranslate"><span class="pre">AllocationStrategy.EQUAL_WEIGHT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.AllocationStrategy.RISK_PARITY"><code class="docutils literal notranslate"><span class="pre">AllocationStrategy.RISK_PARITY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.AllocationStrategy.MEAN_VARIANCE"><code class="docutils literal notranslate"><span class="pre">AllocationStrategy.MEAN_VARIANCE</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.AllocationStrategy.KELLY_CRITERION"><code class="docutils literal notranslate"><span class="pre">AllocationStrategy.KELLY_CRITERION</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.AllocationTarget"><code class="docutils literal notranslate"><span class="pre">AllocationTarget</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.AllocationTarget.protocol"><code class="docutils literal notranslate"><span class="pre">AllocationTarget.protocol</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.AllocationTarget.target_percentage"><code class="docutils literal notranslate"><span class="pre">AllocationTarget.target_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.AllocationTarget.current_percentage"><code class="docutils literal notranslate"><span class="pre">AllocationTarget.current_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.AllocationTarget.risk_score"><code class="docutils literal notranslate"><span class="pre">AllocationTarget.risk_score</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.AllocationTarget.expected_return"><code class="docutils literal notranslate"><span class="pre">AllocationTarget.expected_return</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.AllocationTarget.__init__"><code class="docutils literal notranslate"><span class="pre">AllocationTarget.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.PortfolioMetrics"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.PortfolioMetrics.total_value"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.total_value</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.PortfolioMetrics.total_return"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.total_return</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.PortfolioMetrics.sharpe_ratio"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.sharpe_ratio</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.PortfolioMetrics.max_drawdown"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.max_drawdown</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.PortfolioMetrics.capital_utilization"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.capital_utilization</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.PortfolioMetrics.protocol_allocations"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.protocol_allocations</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.PortfolioMetrics.__init__"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.RebalanceOrder"><code class="docutils literal notranslate"><span class="pre">RebalanceOrder</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.RebalanceOrder.protocol"><code class="docutils literal notranslate"><span class="pre">RebalanceOrder.protocol</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.RebalanceOrder.action"><code class="docutils literal notranslate"><span class="pre">RebalanceOrder.action</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.RebalanceOrder.amount"><code class="docutils literal notranslate"><span class="pre">RebalanceOrder.amount</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.RebalanceOrder.priority"><code class="docutils literal notranslate"><span class="pre">RebalanceOrder.priority</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../capital_allocation.html#airdrops.capital_allocation.engine.RebalanceOrder.__init__"><code class="docutils literal notranslate"><span class="pre">RebalanceOrder.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../monitoring.html">Monitoring API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../monitoring.html#module-airdrops.monitoring">Monitoring Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsCollector"><code class="docutils literal notranslate"><span class="pre">MetricsCollector</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsCollector.__init__"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsCollector.collect_all_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.collect_all_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsCollector.collect_capital_allocator_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.collect_capital_allocator_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsCollector.collect_risk_manager_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.collect_risk_manager_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsCollector.collect_scheduler_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.collect_scheduler_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsCollector.collect_system_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.collect_system_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsCollector.export_prometheus_format"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.export_prometheus_format()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsAggregator"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsAggregator.__init__"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsAggregator.add_metrics_to_buffer"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.add_metrics_to_buffer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsAggregator.aggregate_time_window"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.aggregate_time_window()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsAggregator.get_aggregated_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.get_aggregated_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsAggregator.process_component_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.process_component_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsAggregator.process_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.process_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.MetricsAggregator.process_system_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.process_system_metrics()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.Alerter"><code class="docutils literal notranslate"><span class="pre">Alerter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.Alerter.__init__"><code class="docutils literal notranslate"><span class="pre">Alerter.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.Alerter.evaluate_rules"><code class="docutils literal notranslate"><span class="pre">Alerter.evaluate_rules()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.Alerter.get_active_alerts"><code class="docutils literal notranslate"><span class="pre">Alerter.get_active_alerts()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.Alerter.get_alert_history"><code class="docutils literal notranslate"><span class="pre">Alerter.get_alert_history()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.Alerter.load_alert_rules"><code class="docutils literal notranslate"><span class="pre">Alerter.load_alert_rules()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.Alerter.load_notification_channels"><code class="docutils literal notranslate"><span class="pre">Alerter.load_notification_channels()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.Alerter.send_notifications"><code class="docutils literal notranslate"><span class="pre">Alerter.send_notifications()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.HealthChecker"><code class="docutils literal notranslate"><span class="pre">HealthChecker</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.HealthChecker.__init__"><code class="docutils literal notranslate"><span class="pre">HealthChecker.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.HealthChecker.check_component_health"><code class="docutils literal notranslate"><span class="pre">HealthChecker.check_component_health()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.HealthChecker.check_system_health"><code class="docutils literal notranslate"><span class="pre">HealthChecker.check_system_health()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.HealthChecker.start_server"><code class="docutils literal notranslate"><span class="pre">HealthChecker.start_server()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../monitoring.html#module-airdrops.monitoring.collector">Metrics Collector</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.MetricsCollector"><code class="docutils literal notranslate"><span class="pre">MetricsCollector</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.MetricsCollector.__init__"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.MetricsCollector.collect_system_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.collect_system_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.MetricsCollector.collect_risk_manager_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.collect_risk_manager_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.MetricsCollector.collect_capital_allocator_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.collect_capital_allocator_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.MetricsCollector.collect_scheduler_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.collect_scheduler_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.MetricsCollector.collect_all_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.collect_all_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.MetricsCollector.export_prometheus_format"><code class="docutils literal notranslate"><span class="pre">MetricsCollector.export_prometheus_format()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.SystemMetrics"><code class="docutils literal notranslate"><span class="pre">SystemMetrics</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.SystemMetrics.cpu_usage_percent"><code class="docutils literal notranslate"><span class="pre">SystemMetrics.cpu_usage_percent</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.SystemMetrics.memory_usage_percent"><code class="docutils literal notranslate"><span class="pre">SystemMetrics.memory_usage_percent</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.SystemMetrics.disk_usage_percent"><code class="docutils literal notranslate"><span class="pre">SystemMetrics.disk_usage_percent</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.SystemMetrics.network_bytes_sent"><code class="docutils literal notranslate"><span class="pre">SystemMetrics.network_bytes_sent</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.SystemMetrics.network_bytes_recv"><code class="docutils literal notranslate"><span class="pre">SystemMetrics.network_bytes_recv</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.SystemMetrics.__init__"><code class="docutils literal notranslate"><span class="pre">SystemMetrics.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.ComponentMetrics"><code class="docutils literal notranslate"><span class="pre">ComponentMetrics</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.ComponentMetrics.component_name"><code class="docutils literal notranslate"><span class="pre">ComponentMetrics.component_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.ComponentMetrics.status"><code class="docutils literal notranslate"><span class="pre">ComponentMetrics.status</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.ComponentMetrics.last_execution_time"><code class="docutils literal notranslate"><span class="pre">ComponentMetrics.last_execution_time</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.ComponentMetrics.error_count"><code class="docutils literal notranslate"><span class="pre">ComponentMetrics.error_count</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.ComponentMetrics.success_count"><code class="docutils literal notranslate"><span class="pre">ComponentMetrics.success_count</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.collector.ComponentMetrics.__init__"><code class="docutils literal notranslate"><span class="pre">ComponentMetrics.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../monitoring.html#module-airdrops.monitoring.aggregator">Metrics Aggregator</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.MetricsAggregator"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.MetricsAggregator.__init__"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.MetricsAggregator.add_metrics_to_buffer"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.add_metrics_to_buffer()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.MetricsAggregator.process_system_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.process_system_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.MetricsAggregator.process_component_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.process_component_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.MetricsAggregator.aggregate_time_window"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.aggregate_time_window()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.MetricsAggregator.process_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.process_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.MetricsAggregator.get_aggregated_metrics"><code class="docutils literal notranslate"><span class="pre">MetricsAggregator.get_aggregated_metrics()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.AggregatedMetric"><code class="docutils literal notranslate"><span class="pre">AggregatedMetric</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.AggregatedMetric.metric_name"><code class="docutils literal notranslate"><span class="pre">AggregatedMetric.metric_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.AggregatedMetric.value"><code class="docutils literal notranslate"><span class="pre">AggregatedMetric.value</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.AggregatedMetric.timestamp"><code class="docutils literal notranslate"><span class="pre">AggregatedMetric.timestamp</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.AggregatedMetric.labels"><code class="docutils literal notranslate"><span class="pre">AggregatedMetric.labels</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.AggregatedMetric.aggregation_type"><code class="docutils literal notranslate"><span class="pre">AggregatedMetric.aggregation_type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.AggregatedMetric.__init__"><code class="docutils literal notranslate"><span class="pre">AggregatedMetric.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.AggregationConfig"><code class="docutils literal notranslate"><span class="pre">AggregationConfig</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.AggregationConfig.window_size_seconds"><code class="docutils literal notranslate"><span class="pre">AggregationConfig.window_size_seconds</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.AggregationConfig.aggregation_functions"><code class="docutils literal notranslate"><span class="pre">AggregationConfig.aggregation_functions</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.AggregationConfig.retention_period_hours"><code class="docutils literal notranslate"><span class="pre">AggregationConfig.retention_period_hours</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.aggregator.AggregationConfig.__init__"><code class="docutils literal notranslate"><span class="pre">AggregationConfig.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../monitoring.html#module-airdrops.monitoring.alerter">Alerting System</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alerter"><code class="docutils literal notranslate"><span class="pre">Alerter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alerter.__init__"><code class="docutils literal notranslate"><span class="pre">Alerter.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alerter.load_alert_rules"><code class="docutils literal notranslate"><span class="pre">Alerter.load_alert_rules()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alerter.load_notification_channels"><code class="docutils literal notranslate"><span class="pre">Alerter.load_notification_channels()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alerter.evaluate_rules"><code class="docutils literal notranslate"><span class="pre">Alerter.evaluate_rules()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alerter.send_notifications"><code class="docutils literal notranslate"><span class="pre">Alerter.send_notifications()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alerter.get_active_alerts"><code class="docutils literal notranslate"><span class="pre">Alerter.get_active_alerts()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alerter.get_alert_history"><code class="docutils literal notranslate"><span class="pre">Alerter.get_alert_history()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertRule"><code class="docutils literal notranslate"><span class="pre">AlertRule</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertRule.name"><code class="docutils literal notranslate"><span class="pre">AlertRule.name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertRule.metric_name"><code class="docutils literal notranslate"><span class="pre">AlertRule.metric_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertRule.condition"><code class="docutils literal notranslate"><span class="pre">AlertRule.condition</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertRule.threshold"><code class="docutils literal notranslate"><span class="pre">AlertRule.threshold</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertRule.severity"><code class="docutils literal notranslate"><span class="pre">AlertRule.severity</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertRule.description"><code class="docutils literal notranslate"><span class="pre">AlertRule.description</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertRule.for_duration"><code class="docutils literal notranslate"><span class="pre">AlertRule.for_duration</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertRule.labels"><code class="docutils literal notranslate"><span class="pre">AlertRule.labels</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertRule.__post_init__"><code class="docutils literal notranslate"><span class="pre">AlertRule.__post_init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertRule.__init__"><code class="docutils literal notranslate"><span class="pre">AlertRule.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert"><code class="docutils literal notranslate"><span class="pre">Alert</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert.rule_name"><code class="docutils literal notranslate"><span class="pre">Alert.rule_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert.metric_name"><code class="docutils literal notranslate"><span class="pre">Alert.metric_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert.current_value"><code class="docutils literal notranslate"><span class="pre">Alert.current_value</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert.threshold"><code class="docutils literal notranslate"><span class="pre">Alert.threshold</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert.severity"><code class="docutils literal notranslate"><span class="pre">Alert.severity</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert.status"><code class="docutils literal notranslate"><span class="pre">Alert.status</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert.description"><code class="docutils literal notranslate"><span class="pre">Alert.description</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert.timestamp"><code class="docutils literal notranslate"><span class="pre">Alert.timestamp</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert.labels"><code class="docutils literal notranslate"><span class="pre">Alert.labels</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert.firing_since"><code class="docutils literal notranslate"><span class="pre">Alert.firing_since</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert.resolved_at"><code class="docutils literal notranslate"><span class="pre">Alert.resolved_at</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.Alert.__init__"><code class="docutils literal notranslate"><span class="pre">Alert.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.NotificationChannel"><code class="docutils literal notranslate"><span class="pre">NotificationChannel</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.NotificationChannel.name"><code class="docutils literal notranslate"><span class="pre">NotificationChannel.name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.NotificationChannel.type"><code class="docutils literal notranslate"><span class="pre">NotificationChannel.type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.NotificationChannel.config"><code class="docutils literal notranslate"><span class="pre">NotificationChannel.config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.NotificationChannel.enabled"><code class="docutils literal notranslate"><span class="pre">NotificationChannel.enabled</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.NotificationChannel.__init__"><code class="docutils literal notranslate"><span class="pre">NotificationChannel.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertSeverity"><code class="docutils literal notranslate"><span class="pre">AlertSeverity</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertSeverity.LOW"><code class="docutils literal notranslate"><span class="pre">AlertSeverity.LOW</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertSeverity.MEDIUM"><code class="docutils literal notranslate"><span class="pre">AlertSeverity.MEDIUM</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertSeverity.HIGH"><code class="docutils literal notranslate"><span class="pre">AlertSeverity.HIGH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertSeverity.CRITICAL"><code class="docutils literal notranslate"><span class="pre">AlertSeverity.CRITICAL</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertStatus"><code class="docutils literal notranslate"><span class="pre">AlertStatus</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertStatus.FIRING"><code class="docutils literal notranslate"><span class="pre">AlertStatus.FIRING</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertStatus.RESOLVED"><code class="docutils literal notranslate"><span class="pre">AlertStatus.RESOLVED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.alerter.AlertStatus.PENDING"><code class="docutils literal notranslate"><span class="pre">AlertStatus.PENDING</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../monitoring.html#module-airdrops.monitoring.health_checker">Health Checker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.HealthChecker"><code class="docutils literal notranslate"><span class="pre">HealthChecker</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.HealthChecker.__init__"><code class="docutils literal notranslate"><span class="pre">HealthChecker.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.HealthChecker.check_system_health"><code class="docutils literal notranslate"><span class="pre">HealthChecker.check_system_health()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.HealthChecker.check_component_health"><code class="docutils literal notranslate"><span class="pre">HealthChecker.check_component_health()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.HealthChecker.start_server"><code class="docutils literal notranslate"><span class="pre">HealthChecker.start_server()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.HealthStatus"><code class="docutils literal notranslate"><span class="pre">HealthStatus</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.HealthStatus.OK"><code class="docutils literal notranslate"><span class="pre">HealthStatus.OK</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.HealthStatus.WARNING"><code class="docutils literal notranslate"><span class="pre">HealthStatus.WARNING</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.HealthStatus.CRITICAL"><code class="docutils literal notranslate"><span class="pre">HealthStatus.CRITICAL</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.ComponentHealth"><code class="docutils literal notranslate"><span class="pre">ComponentHealth</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.ComponentHealth.component_name"><code class="docutils literal notranslate"><span class="pre">ComponentHealth.component_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.ComponentHealth.status"><code class="docutils literal notranslate"><span class="pre">ComponentHealth.status</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.ComponentHealth.message"><code class="docutils literal notranslate"><span class="pre">ComponentHealth.message</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.ComponentHealth.last_check"><code class="docutils literal notranslate"><span class="pre">ComponentHealth.last_check</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.ComponentHealth.metrics"><code class="docutils literal notranslate"><span class="pre">ComponentHealth.metrics</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.ComponentHealth.__init__"><code class="docutils literal notranslate"><span class="pre">ComponentHealth.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.SystemHealth"><code class="docutils literal notranslate"><span class="pre">SystemHealth</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.SystemHealth.overall_status"><code class="docutils literal notranslate"><span class="pre">SystemHealth.overall_status</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.SystemHealth.timestamp"><code class="docutils literal notranslate"><span class="pre">SystemHealth.timestamp</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.SystemHealth.components"><code class="docutils literal notranslate"><span class="pre">SystemHealth.components</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.SystemHealth.summary"><code class="docutils literal notranslate"><span class="pre">SystemHealth.summary</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../monitoring.html#airdrops.monitoring.health_checker.SystemHealth.__init__"><code class="docutils literal notranslate"><span class="pre">SystemHealth.__init__()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../analytics.html">Analytics API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../analytics.html#module-airdrops.analytics">Analytics Module</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropTracker"><code class="docutils literal notranslate"><span class="pre">AirdropTracker</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropTracker.__init__"><code class="docutils literal notranslate"><span class="pre">AirdropTracker.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropTracker.get_airdrops_by_date_range"><code class="docutils literal notranslate"><span class="pre">AirdropTracker.get_airdrops_by_date_range()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropTracker.get_airdrops_by_protocol"><code class="docutils literal notranslate"><span class="pre">AirdropTracker.get_airdrops_by_protocol()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropTracker.get_airdrops_by_wallet"><code class="docutils literal notranslate"><span class="pre">AirdropTracker.get_airdrops_by_wallet()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropTracker.record_airdrop"><code class="docutils literal notranslate"><span class="pre">AirdropTracker.record_airdrop()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent"><code class="docutils literal notranslate"><span class="pre">AirdropEvent</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.ConfigDict"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.ConfigDict</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.model_config"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.validate_protocol_name"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.validate_protocol_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.validate_token_symbol"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.validate_token_symbol()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.protocol_name"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.protocol_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.token_symbol"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.token_symbol</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.amount_received"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.amount_received</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.estimated_value_usd"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.estimated_value_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.wallet_address"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.wallet_address</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.transaction_hash"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.transaction_hash</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.block_number"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.block_number</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.event_date"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.event_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropEvent.notes"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.notes</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropReporter"><code class="docutils literal notranslate"><span class="pre">AirdropReporter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropReporter.__init__"><code class="docutils literal notranslate"><span class="pre">AirdropReporter.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropReporter.enable_portfolio_analytics"><code class="docutils literal notranslate"><span class="pre">AirdropReporter.enable_portfolio_analytics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropReporter.enable_roi_analysis"><code class="docutils literal notranslate"><span class="pre">AirdropReporter.enable_roi_analysis()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropReporter.export_report"><code class="docutils literal notranslate"><span class="pre">AirdropReporter.export_report()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropReporter.generate_comprehensive_report"><code class="docutils literal notranslate"><span class="pre">AirdropReporter.generate_comprehensive_report()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropReporter.generate_protocol_report"><code class="docutils literal notranslate"><span class="pre">AirdropReporter.generate_protocol_report()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ReportFormat"><code class="docutils literal notranslate"><span class="pre">ReportFormat</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ReportFormat.JSON"><code class="docutils literal notranslate"><span class="pre">ReportFormat.JSON</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ReportFormat.CSV"><code class="docutils literal notranslate"><span class="pre">ReportFormat.CSV</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ReportFormat.CONSOLE"><code class="docutils literal notranslate"><span class="pre">ReportFormat.CONSOLE</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIOptimizer"><code class="docutils literal notranslate"><span class="pre">ROIOptimizer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIOptimizer.__init__"><code class="docutils literal notranslate"><span class="pre">ROIOptimizer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIOptimizer.calculate_portfolio_roi"><code class="docutils literal notranslate"><span class="pre">ROIOptimizer.calculate_portfolio_roi()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIOptimizer.calculate_protocol_roi"><code class="docutils literal notranslate"><span class="pre">ROIOptimizer.calculate_protocol_roi()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIOptimizer.generate_optimization_suggestions"><code class="docutils literal notranslate"><span class="pre">ROIOptimizer.generate_optimization_suggestions()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIOptimizer.set_protocol_cost_data"><code class="docutils literal notranslate"><span class="pre">ROIOptimizer.set_protocol_cost_data()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIMetrics"><code class="docutils literal notranslate"><span class="pre">ROIMetrics</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIMetrics.model_config"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIMetrics.protocol_name"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.protocol_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIMetrics.total_revenue_usd"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.total_revenue_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIMetrics.total_cost_usd"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.total_cost_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIMetrics.roi_percentage"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.roi_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIMetrics.profit_usd"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.profit_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIMetrics.transaction_count"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.transaction_count</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIMetrics.revenue_per_transaction"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.revenue_per_transaction</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIMetrics.cost_per_transaction"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.cost_per_transaction</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.ROIMetrics.calculation_date"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.calculation_date</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationSuggestion"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationSuggestion.model_config"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationSuggestion.protocol_name"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.protocol_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationSuggestion.suggestion_type"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.suggestion_type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationSuggestion.priority"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.priority</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationSuggestion.description"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.description</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationSuggestion.expected_impact"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.expected_impact</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationSuggestion.current_roi"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.current_roi</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationSuggestion.potential_roi"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.potential_roi</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.CostData"><code class="docutils literal notranslate"><span class="pre">CostData</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.CostData.model_config"><code class="docutils literal notranslate"><span class="pre">CostData.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.CostData.protocol_name"><code class="docutils literal notranslate"><span class="pre">CostData.protocol_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.CostData.total_gas_cost_usd"><code class="docutils literal notranslate"><span class="pre">CostData.total_gas_cost_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.CostData.transaction_count"><code class="docutils literal notranslate"><span class="pre">CostData.transaction_count</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.CostData.average_gas_cost_usd"><code class="docutils literal notranslate"><span class="pre">CostData.average_gas_cost_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.CostData.manual_cost_usd"><code class="docutils literal notranslate"><span class="pre">CostData.manual_cost_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.CostData.time_investment_hours"><code class="docutils literal notranslate"><span class="pre">CostData.time_investment_hours</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.CostModel"><code class="docutils literal notranslate"><span class="pre">CostModel</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.CostModel.SIMPLE_GAS"><code class="docutils literal notranslate"><span class="pre">CostModel.SIMPLE_GAS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.CostModel.MANUAL_INPUT"><code class="docutils literal notranslate"><span class="pre">CostModel.MANUAL_INPUT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.CostModel.ESTIMATED"><code class="docutils literal notranslate"><span class="pre">CostModel.ESTIMATED</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationStrategy"><code class="docutils literal notranslate"><span class="pre">OptimizationStrategy</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationStrategy.ROI_MAXIMIZATION"><code class="docutils literal notranslate"><span class="pre">OptimizationStrategy.ROI_MAXIMIZATION</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationStrategy.RISK_ADJUSTED"><code class="docutils literal notranslate"><span class="pre">OptimizationStrategy.RISK_ADJUSTED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OptimizationStrategy.DIVERSIFIED"><code class="docutils literal notranslate"><span class="pre">OptimizationStrategy.DIVERSIFIED</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropPredictor"><code class="docutils literal notranslate"><span class="pre">AirdropPredictor</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropPredictor.__init__"><code class="docutils literal notranslate"><span class="pre">AirdropPredictor.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropPredictor.get_data_source_status"><code class="docutils literal notranslate"><span class="pre">AirdropPredictor.get_data_source_status()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropPredictor.predict_airdrop_timing"><code class="docutils literal notranslate"><span class="pre">AirdropPredictor.predict_airdrop_timing()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.AirdropPredictor.update_prediction_model"><code class="docutils literal notranslate"><span class="pre">AirdropPredictor.update_prediction_model()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionResult"><code class="docutils literal notranslate"><span class="pre">PredictionResult</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionResult.model_config"><code class="docutils literal notranslate"><span class="pre">PredictionResult.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionResult.validate_protocol_name"><code class="docutils literal notranslate"><span class="pre">PredictionResult.validate_protocol_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionResult.protocol_name"><code class="docutils literal notranslate"><span class="pre">PredictionResult.protocol_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionResult.prediction_windows"><code class="docutils literal notranslate"><span class="pre">PredictionResult.prediction_windows</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionResult.confidence_level"><code class="docutils literal notranslate"><span class="pre">PredictionResult.confidence_level</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionResult.model_version"><code class="docutils literal notranslate"><span class="pre">PredictionResult.model_version</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionResult.data_sources_used"><code class="docutils literal notranslate"><span class="pre">PredictionResult.data_sources_used</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionResult.prediction_date"><code class="docutils literal notranslate"><span class="pre">PredictionResult.prediction_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionResult.next_review_date"><code class="docutils literal notranslate"><span class="pre">PredictionResult.next_review_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionResult.metadata"><code class="docutils literal notranslate"><span class="pre">PredictionResult.metadata</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionWindow"><code class="docutils literal notranslate"><span class="pre">PredictionWindow</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionWindow.model_config"><code class="docutils literal notranslate"><span class="pre">PredictionWindow.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionWindow.validate_end_after_start"><code class="docutils literal notranslate"><span class="pre">PredictionWindow.validate_end_after_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionWindow.start_date"><code class="docutils literal notranslate"><span class="pre">PredictionWindow.start_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionWindow.end_date"><code class="docutils literal notranslate"><span class="pre">PredictionWindow.end_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionWindow.probability"><code class="docutils literal notranslate"><span class="pre">PredictionWindow.probability</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionConfidence"><code class="docutils literal notranslate"><span class="pre">PredictionConfidence</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionConfidence.LOW"><code class="docutils literal notranslate"><span class="pre">PredictionConfidence.LOW</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionConfidence.MEDIUM"><code class="docutils literal notranslate"><span class="pre">PredictionConfidence.MEDIUM</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PredictionConfidence.HIGH"><code class="docutils literal notranslate"><span class="pre">PredictionConfidence.HIGH</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.DataSourceType"><code class="docutils literal notranslate"><span class="pre">DataSourceType</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.DataSourceType.HISTORICAL_AIRDROPS"><code class="docutils literal notranslate"><span class="pre">DataSourceType.HISTORICAL_AIRDROPS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.DataSourceType.MARKET_DATA"><code class="docutils literal notranslate"><span class="pre">DataSourceType.MARKET_DATA</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.DataSourceType.ONCHAIN_ACTIVITY"><code class="docutils literal notranslate"><span class="pre">DataSourceType.ONCHAIN_ACTIVITY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.DataSourceType.SOCIAL_SENTIMENT"><code class="docutils literal notranslate"><span class="pre">DataSourceType.SOCIAL_SENTIMENT</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.MarketDataStub"><code class="docutils literal notranslate"><span class="pre">MarketDataStub</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.MarketDataStub.get_token_price_history"><code class="docutils literal notranslate"><span class="pre">MarketDataStub.get_token_price_history()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OnChainActivityStub"><code class="docutils literal notranslate"><span class="pre">OnChainActivityStub</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.OnChainActivityStub.get_protocol_activity_metrics"><code class="docutils literal notranslate"><span class="pre">OnChainActivityStub.get_protocol_activity_metrics()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.SocialSentimentStub"><code class="docutils literal notranslate"><span class="pre">SocialSentimentStub</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.SocialSentimentStub.get_sentiment_score"><code class="docutils literal notranslate"><span class="pre">SocialSentimentStub.get_sentiment_score()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioPerformanceAnalyzer"><code class="docutils literal notranslate"><span class="pre">PortfolioPerformanceAnalyzer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioPerformanceAnalyzer.__init__"><code class="docutils literal notranslate"><span class="pre">PortfolioPerformanceAnalyzer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioPerformanceAnalyzer.calculate_portfolio_metrics"><code class="docutils literal notranslate"><span class="pre">PortfolioPerformanceAnalyzer.calculate_portfolio_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioPerformanceAnalyzer.calculate_portfolio_value_over_time"><code class="docutils literal notranslate"><span class="pre">PortfolioPerformanceAnalyzer.calculate_portfolio_value_over_time()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioPerformanceAnalyzer.compare_to_benchmark"><code class="docutils literal notranslate"><span class="pre">PortfolioPerformanceAnalyzer.compare_to_benchmark()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioMetrics"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioMetrics.model_config"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioMetrics.calculation_date"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.calculation_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioMetrics.total_portfolio_value_usd"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.total_portfolio_value_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioMetrics.total_profit_loss_usd"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.total_profit_loss_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioMetrics.total_cost_usd"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.total_cost_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioMetrics.portfolio_roi_percentage"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.portfolio_roi_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioMetrics.protocol_count"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.protocol_count</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioMetrics.token_count"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.token_count</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioMetrics.diversification_index"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.diversification_index</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioMetrics.largest_position_percentage"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.largest_position_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioMetrics.value_at_risk_usd"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.value_at_risk_usd</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioSnapshot"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioSnapshot.model_config"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioSnapshot.snapshot_date"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot.snapshot_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioSnapshot.total_value_usd"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot.total_value_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioSnapshot.protocol_allocations"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot.protocol_allocations</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioSnapshot.token_allocations"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot.token_allocations</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.PortfolioSnapshot.diversification_score"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot.diversification_score</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.BenchmarkComparison"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.BenchmarkComparison.model_config"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.model_config</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.BenchmarkComparison.benchmark_type"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.benchmark_type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.BenchmarkComparison.portfolio_return_percentage"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.portfolio_return_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.BenchmarkComparison.benchmark_return_percentage"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.benchmark_return_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.BenchmarkComparison.alpha_percentage"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.alpha_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.BenchmarkComparison.comparison_period_days"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.comparison_period_days</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.BenchmarkComparison.calculation_date"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.calculation_date</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.BenchmarkType"><code class="docutils literal notranslate"><span class="pre">BenchmarkType</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.BenchmarkType.ETH"><code class="docutils literal notranslate"><span class="pre">BenchmarkType.ETH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.BenchmarkType.BTC"><code class="docutils literal notranslate"><span class="pre">BenchmarkType.BTC</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.BenchmarkType.MARKET_INDEX"><code class="docutils literal notranslate"><span class="pre">BenchmarkType.MARKET_INDEX</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analytics.html#module-airdrops.analytics.tracker">Airdrop Tracker</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.Base"><code class="docutils literal notranslate"><span class="pre">Base</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.Base.__init__"><code class="docutils literal notranslate"><span class="pre">Base.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.Base.metadata"><code class="docutils literal notranslate"><span class="pre">Base.metadata</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.Base.registry"><code class="docutils literal notranslate"><span class="pre">Base.registry</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel.id"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel.id</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel.protocol_name"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel.protocol_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel.token_symbol"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel.token_symbol</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel.amount_received"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel.amount_received</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel.estimated_value_usd"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel.estimated_value_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel.wallet_address"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel.wallet_address</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel.transaction_hash"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel.transaction_hash</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel.block_number"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel.block_number</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel.event_date"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel.event_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel.created_at"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel.created_at</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel.notes"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel.notes</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEventModel.__init__"><code class="docutils literal notranslate"><span class="pre">AirdropEventModel.__init__()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent"><code class="docutils literal notranslate"><span class="pre">AirdropEvent</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.protocol_name"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.protocol_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.token_symbol"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.token_symbol</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.amount_received"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.amount_received</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.estimated_value_usd"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.estimated_value_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.wallet_address"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.wallet_address</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.transaction_hash"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.transaction_hash</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.block_number"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.block_number</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.event_date"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.event_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.notes"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.notes</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.validate_protocol_name"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.validate_protocol_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.validate_token_symbol"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.validate_token_symbol()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.ConfigDict"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.ConfigDict</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropEvent.model_config"><code class="docutils literal notranslate"><span class="pre">AirdropEvent.model_config</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropTracker"><code class="docutils literal notranslate"><span class="pre">AirdropTracker</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropTracker.__init__"><code class="docutils literal notranslate"><span class="pre">AirdropTracker.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropTracker.record_airdrop"><code class="docutils literal notranslate"><span class="pre">AirdropTracker.record_airdrop()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropTracker.get_airdrops_by_protocol"><code class="docutils literal notranslate"><span class="pre">AirdropTracker.get_airdrops_by_protocol()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropTracker.get_airdrops_by_wallet"><code class="docutils literal notranslate"><span class="pre">AirdropTracker.get_airdrops_by_wallet()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.tracker.AirdropTracker.get_airdrops_by_date_range"><code class="docutils literal notranslate"><span class="pre">AirdropTracker.get_airdrops_by_date_range()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analytics.html#module-airdrops.analytics.reporter">Airdrop Reporter</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ReportFormat"><code class="docutils literal notranslate"><span class="pre">ReportFormat</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ReportFormat.JSON"><code class="docutils literal notranslate"><span class="pre">ReportFormat.JSON</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ReportFormat.CSV"><code class="docutils literal notranslate"><span class="pre">ReportFormat.CSV</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ReportFormat.CONSOLE"><code class="docutils literal notranslate"><span class="pre">ReportFormat.CONSOLE</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ProtocolSummary"><code class="docutils literal notranslate"><span class="pre">ProtocolSummary</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ProtocolSummary.protocol_name"><code class="docutils literal notranslate"><span class="pre">ProtocolSummary.protocol_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ProtocolSummary.total_events"><code class="docutils literal notranslate"><span class="pre">ProtocolSummary.total_events</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ProtocolSummary.total_tokens_received"><code class="docutils literal notranslate"><span class="pre">ProtocolSummary.total_tokens_received</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ProtocolSummary.total_estimated_value_usd"><code class="docutils literal notranslate"><span class="pre">ProtocolSummary.total_estimated_value_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ProtocolSummary.unique_tokens"><code class="docutils literal notranslate"><span class="pre">ProtocolSummary.unique_tokens</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ProtocolSummary.first_airdrop_date"><code class="docutils literal notranslate"><span class="pre">ProtocolSummary.first_airdrop_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ProtocolSummary.last_airdrop_date"><code class="docutils literal notranslate"><span class="pre">ProtocolSummary.last_airdrop_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.ProtocolSummary.model_config"><code class="docutils literal notranslate"><span class="pre">ProtocolSummary.model_config</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport"><code class="docutils literal notranslate"><span class="pre">AirdropReport</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.report_generated_at"><code class="docutils literal notranslate"><span class="pre">AirdropReport.report_generated_at</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.total_airdrops"><code class="docutils literal notranslate"><span class="pre">AirdropReport.total_airdrops</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.total_protocols"><code class="docutils literal notranslate"><span class="pre">AirdropReport.total_protocols</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.total_estimated_value_usd"><code class="docutils literal notranslate"><span class="pre">AirdropReport.total_estimated_value_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.date_range_start"><code class="docutils literal notranslate"><span class="pre">AirdropReport.date_range_start</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.date_range_end"><code class="docutils literal notranslate"><span class="pre">AirdropReport.date_range_end</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.protocol_summaries"><code class="docutils literal notranslate"><span class="pre">AirdropReport.protocol_summaries</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.top_protocols_by_value"><code class="docutils literal notranslate"><span class="pre">AirdropReport.top_protocols_by_value</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.monthly_breakdown"><code class="docutils literal notranslate"><span class="pre">AirdropReport.monthly_breakdown</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.roi_metrics"><code class="docutils literal notranslate"><span class="pre">AirdropReport.roi_metrics</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.optimization_suggestions"><code class="docutils literal notranslate"><span class="pre">AirdropReport.optimization_suggestions</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.portfolio_metrics"><code class="docutils literal notranslate"><span class="pre">AirdropReport.portfolio_metrics</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReport.model_config"><code class="docutils literal notranslate"><span class="pre">AirdropReport.model_config</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReporter"><code class="docutils literal notranslate"><span class="pre">AirdropReporter</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReporter.__init__"><code class="docutils literal notranslate"><span class="pre">AirdropReporter.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReporter.enable_roi_analysis"><code class="docutils literal notranslate"><span class="pre">AirdropReporter.enable_roi_analysis()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReporter.enable_portfolio_analytics"><code class="docutils literal notranslate"><span class="pre">AirdropReporter.enable_portfolio_analytics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReporter.generate_comprehensive_report"><code class="docutils literal notranslate"><span class="pre">AirdropReporter.generate_comprehensive_report()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReporter.generate_protocol_report"><code class="docutils literal notranslate"><span class="pre">AirdropReporter.generate_protocol_report()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.reporter.AirdropReporter.export_report"><code class="docutils literal notranslate"><span class="pre">AirdropReporter.export_report()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analytics.html#module-airdrops.analytics.optimizer">ROI Optimizer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.CostModel"><code class="docutils literal notranslate"><span class="pre">CostModel</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.CostModel.SIMPLE_GAS"><code class="docutils literal notranslate"><span class="pre">CostModel.SIMPLE_GAS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.CostModel.MANUAL_INPUT"><code class="docutils literal notranslate"><span class="pre">CostModel.MANUAL_INPUT</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.CostModel.ESTIMATED"><code class="docutils literal notranslate"><span class="pre">CostModel.ESTIMATED</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationStrategy"><code class="docutils literal notranslate"><span class="pre">OptimizationStrategy</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationStrategy.ROI_MAXIMIZATION"><code class="docutils literal notranslate"><span class="pre">OptimizationStrategy.ROI_MAXIMIZATION</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationStrategy.RISK_ADJUSTED"><code class="docutils literal notranslate"><span class="pre">OptimizationStrategy.RISK_ADJUSTED</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationStrategy.DIVERSIFIED"><code class="docutils literal notranslate"><span class="pre">OptimizationStrategy.DIVERSIFIED</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.CostData"><code class="docutils literal notranslate"><span class="pre">CostData</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.CostData.protocol_name"><code class="docutils literal notranslate"><span class="pre">CostData.protocol_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.CostData.total_gas_cost_usd"><code class="docutils literal notranslate"><span class="pre">CostData.total_gas_cost_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.CostData.transaction_count"><code class="docutils literal notranslate"><span class="pre">CostData.transaction_count</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.CostData.average_gas_cost_usd"><code class="docutils literal notranslate"><span class="pre">CostData.average_gas_cost_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.CostData.manual_cost_usd"><code class="docutils literal notranslate"><span class="pre">CostData.manual_cost_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.CostData.time_investment_hours"><code class="docutils literal notranslate"><span class="pre">CostData.time_investment_hours</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.CostData.model_config"><code class="docutils literal notranslate"><span class="pre">CostData.model_config</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIMetrics"><code class="docutils literal notranslate"><span class="pre">ROIMetrics</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIMetrics.protocol_name"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.protocol_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIMetrics.total_revenue_usd"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.total_revenue_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIMetrics.total_cost_usd"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.total_cost_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIMetrics.roi_percentage"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.roi_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIMetrics.profit_usd"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.profit_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIMetrics.transaction_count"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.transaction_count</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIMetrics.revenue_per_transaction"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.revenue_per_transaction</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIMetrics.cost_per_transaction"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.cost_per_transaction</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIMetrics.calculation_date"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.calculation_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIMetrics.model_config"><code class="docutils literal notranslate"><span class="pre">ROIMetrics.model_config</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationSuggestion"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationSuggestion.protocol_name"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.protocol_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationSuggestion.suggestion_type"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.suggestion_type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationSuggestion.priority"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.priority</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationSuggestion.description"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.description</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationSuggestion.expected_impact"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.expected_impact</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationSuggestion.current_roi"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.current_roi</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationSuggestion.potential_roi"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.potential_roi</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.OptimizationSuggestion.model_config"><code class="docutils literal notranslate"><span class="pre">OptimizationSuggestion.model_config</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIOptimizer"><code class="docutils literal notranslate"><span class="pre">ROIOptimizer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIOptimizer.__init__"><code class="docutils literal notranslate"><span class="pre">ROIOptimizer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIOptimizer.set_protocol_cost_data"><code class="docutils literal notranslate"><span class="pre">ROIOptimizer.set_protocol_cost_data()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIOptimizer.calculate_protocol_roi"><code class="docutils literal notranslate"><span class="pre">ROIOptimizer.calculate_protocol_roi()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIOptimizer.calculate_portfolio_roi"><code class="docutils literal notranslate"><span class="pre">ROIOptimizer.calculate_portfolio_roi()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.optimizer.ROIOptimizer.generate_optimization_suggestions"><code class="docutils literal notranslate"><span class="pre">ROIOptimizer.generate_optimization_suggestions()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analytics.html#module-airdrops.analytics.portfolio">Portfolio Performance Analyzer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.BenchmarkType"><code class="docutils literal notranslate"><span class="pre">BenchmarkType</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.BenchmarkType.ETH"><code class="docutils literal notranslate"><span class="pre">BenchmarkType.ETH</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.BenchmarkType.BTC"><code class="docutils literal notranslate"><span class="pre">BenchmarkType.BTC</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.BenchmarkType.MARKET_INDEX"><code class="docutils literal notranslate"><span class="pre">BenchmarkType.MARKET_INDEX</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioSnapshot"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioSnapshot.snapshot_date"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot.snapshot_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioSnapshot.total_value_usd"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot.total_value_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioSnapshot.protocol_allocations"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot.protocol_allocations</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioSnapshot.token_allocations"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot.token_allocations</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioSnapshot.diversification_score"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot.diversification_score</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioSnapshot.model_config"><code class="docutils literal notranslate"><span class="pre">PortfolioSnapshot.model_config</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioMetrics"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioMetrics.calculation_date"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.calculation_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioMetrics.total_portfolio_value_usd"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.total_portfolio_value_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioMetrics.total_profit_loss_usd"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.total_profit_loss_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioMetrics.total_cost_usd"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.total_cost_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioMetrics.portfolio_roi_percentage"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.portfolio_roi_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioMetrics.protocol_count"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.protocol_count</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioMetrics.token_count"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.token_count</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioMetrics.diversification_index"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.diversification_index</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioMetrics.largest_position_percentage"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.largest_position_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioMetrics.value_at_risk_usd"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.value_at_risk_usd</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioMetrics.model_config"><code class="docutils literal notranslate"><span class="pre">PortfolioMetrics.model_config</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.BenchmarkComparison"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.BenchmarkComparison.benchmark_type"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.benchmark_type</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.BenchmarkComparison.portfolio_return_percentage"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.portfolio_return_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.BenchmarkComparison.benchmark_return_percentage"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.benchmark_return_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.BenchmarkComparison.alpha_percentage"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.alpha_percentage</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.BenchmarkComparison.comparison_period_days"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.comparison_period_days</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.BenchmarkComparison.calculation_date"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.calculation_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.BenchmarkComparison.model_config"><code class="docutils literal notranslate"><span class="pre">BenchmarkComparison.model_config</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioPerformanceAnalyzer"><code class="docutils literal notranslate"><span class="pre">PortfolioPerformanceAnalyzer</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioPerformanceAnalyzer.__init__"><code class="docutils literal notranslate"><span class="pre">PortfolioPerformanceAnalyzer.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioPerformanceAnalyzer.calculate_portfolio_metrics"><code class="docutils literal notranslate"><span class="pre">PortfolioPerformanceAnalyzer.calculate_portfolio_metrics()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioPerformanceAnalyzer.calculate_portfolio_value_over_time"><code class="docutils literal notranslate"><span class="pre">PortfolioPerformanceAnalyzer.calculate_portfolio_value_over_time()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.portfolio.PortfolioPerformanceAnalyzer.compare_to_benchmark"><code class="docutils literal notranslate"><span class="pre">PortfolioPerformanceAnalyzer.compare_to_benchmark()</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../../analytics.html#module-airdrops.analytics.predictor">Airdrop Predictor</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.DataSourceType"><code class="docutils literal notranslate"><span class="pre">DataSourceType</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.DataSourceType.HISTORICAL_AIRDROPS"><code class="docutils literal notranslate"><span class="pre">DataSourceType.HISTORICAL_AIRDROPS</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.DataSourceType.MARKET_DATA"><code class="docutils literal notranslate"><span class="pre">DataSourceType.MARKET_DATA</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.DataSourceType.ONCHAIN_ACTIVITY"><code class="docutils literal notranslate"><span class="pre">DataSourceType.ONCHAIN_ACTIVITY</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.DataSourceType.SOCIAL_SENTIMENT"><code class="docutils literal notranslate"><span class="pre">DataSourceType.SOCIAL_SENTIMENT</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionConfidence"><code class="docutils literal notranslate"><span class="pre">PredictionConfidence</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionConfidence.LOW"><code class="docutils literal notranslate"><span class="pre">PredictionConfidence.LOW</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionConfidence.MEDIUM"><code class="docutils literal notranslate"><span class="pre">PredictionConfidence.MEDIUM</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionConfidence.HIGH"><code class="docutils literal notranslate"><span class="pre">PredictionConfidence.HIGH</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionWindow"><code class="docutils literal notranslate"><span class="pre">PredictionWindow</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionWindow.start_date"><code class="docutils literal notranslate"><span class="pre">PredictionWindow.start_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionWindow.end_date"><code class="docutils literal notranslate"><span class="pre">PredictionWindow.end_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionWindow.probability"><code class="docutils literal notranslate"><span class="pre">PredictionWindow.probability</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionWindow.validate_end_after_start"><code class="docutils literal notranslate"><span class="pre">PredictionWindow.validate_end_after_start()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionWindow.model_config"><code class="docutils literal notranslate"><span class="pre">PredictionWindow.model_config</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionResult"><code class="docutils literal notranslate"><span class="pre">PredictionResult</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionResult.protocol_name"><code class="docutils literal notranslate"><span class="pre">PredictionResult.protocol_name</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionResult.prediction_windows"><code class="docutils literal notranslate"><span class="pre">PredictionResult.prediction_windows</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionResult.confidence_level"><code class="docutils literal notranslate"><span class="pre">PredictionResult.confidence_level</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionResult.model_version"><code class="docutils literal notranslate"><span class="pre">PredictionResult.model_version</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionResult.data_sources_used"><code class="docutils literal notranslate"><span class="pre">PredictionResult.data_sources_used</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionResult.prediction_date"><code class="docutils literal notranslate"><span class="pre">PredictionResult.prediction_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionResult.next_review_date"><code class="docutils literal notranslate"><span class="pre">PredictionResult.next_review_date</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionResult.metadata"><code class="docutils literal notranslate"><span class="pre">PredictionResult.metadata</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionResult.validate_protocol_name"><code class="docutils literal notranslate"><span class="pre">PredictionResult.validate_protocol_name()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.PredictionResult.model_config"><code class="docutils literal notranslate"><span class="pre">PredictionResult.model_config</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.MarketDataStub"><code class="docutils literal notranslate"><span class="pre">MarketDataStub</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.MarketDataStub.get_token_price_history"><code class="docutils literal notranslate"><span class="pre">MarketDataStub.get_token_price_history()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.OnChainActivityStub"><code class="docutils literal notranslate"><span class="pre">OnChainActivityStub</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.OnChainActivityStub.get_protocol_activity_metrics"><code class="docutils literal notranslate"><span class="pre">OnChainActivityStub.get_protocol_activity_metrics()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.SocialSentimentStub"><code class="docutils literal notranslate"><span class="pre">SocialSentimentStub</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.SocialSentimentStub.get_sentiment_score"><code class="docutils literal notranslate"><span class="pre">SocialSentimentStub.get_sentiment_score()</span></code></a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.AirdropPredictor"><code class="docutils literal notranslate"><span class="pre">AirdropPredictor</span></code></a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.AirdropPredictor.__init__"><code class="docutils literal notranslate"><span class="pre">AirdropPredictor.__init__()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.AirdropPredictor.predict_airdrop_timing"><code class="docutils literal notranslate"><span class="pre">AirdropPredictor.predict_airdrop_timing()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.AirdropPredictor.get_data_source_status"><code class="docutils literal notranslate"><span class="pre">AirdropPredictor.get_data_source_status()</span></code></a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../../analytics.html#airdrops.analytics.predictor.AirdropPredictor.update_prediction_model"><code class="docutils literal notranslate"><span class="pre">AirdropPredictor.update_prediction_model()</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../../shared.html">Shared Utilities API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../shared.html#module-airdrops.shared">Shared Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../../shared.html#module-airdrops.shared.config">Configuration</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Airdrops Automation API Docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">airdrops.protocols.scroll.scroll</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for airdrops.protocols.scroll.scroll</h1><div class="highlight"><pre>
<span></span><span class="c1"># airdrops/src/airdrops/protocols/scroll/scroll.py</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Scroll Protocol Module.</span>

<span class="sd">This module provides functionalities to interact with the Scroll network,</span>
<span class="sd">including bridging ETH and ERC20 tokens between Ethereum (L1) and Scroll (L2),</span>
<span class="sd">and swapping tokens on SyncSwap DEX (L2).</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">cast</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">requests.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="ne">ConnectionError</span><span class="p">,</span> <span class="n">Timeout</span>  <span class="c1"># Added Timeout</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">eth_abi.abi</span><span class="w"> </span><span class="kn">import</span> <span class="n">encode</span> <span class="k">as</span> <span class="n">abi_encode</span>  <span class="c1"># Corrected import path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">hexbytes</span><span class="w"> </span><span class="kn">import</span> <span class="n">HexBytes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">web3</span><span class="w"> </span><span class="kn">import</span> <span class="n">Web3</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">web3.contract</span><span class="w"> </span><span class="kn">import</span> <span class="n">Contract</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">web3.contract.contract</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContractFunction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">web3.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ContractLogicError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eth_account</span><span class="w"> </span><span class="kn">import</span> <span class="n">Account</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">eth_account.signers.local</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalAccount</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">web3.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">TxParams</span><span class="p">,</span> <span class="n">Wei</span><span class="p">,</span> <span class="n">TxReceipt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">airdrops.shared</span><span class="w"> </span><span class="kn">import</span> <span class="n">config</span> <span class="k">as</span> <span class="n">shared_config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">ScrollBridgeError</span><span class="p">,</span>
    <span class="n">InsufficientBalanceError</span><span class="p">,</span>
    <span class="n">TransactionRevertedError</span><span class="p">,</span>
    <span class="n">ApprovalError</span><span class="p">,</span>
    <span class="n">GasEstimationError</span><span class="p">,</span>
    <span class="n">MaxRetriesExceededError</span><span class="p">,</span>
    <span class="n">TransactionBuildError</span><span class="p">,</span>
    <span class="n">TransactionSendError</span><span class="p">,</span>
    <span class="n">ScrollSwapError</span><span class="p">,</span>
    <span class="n">InsufficientLiquidityError</span><span class="p">,</span>
    <span class="n">TokenNotSupportedError</span><span class="p">,</span>
    <span class="n">ScrollLendingError</span><span class="p">,</span>
    <span class="n">InsufficientCollateralError</span><span class="p">,</span>
    <span class="n">RepayAmountExceedsDebtError</span><span class="p">,</span>
    <span class="n">LayerBankComptrollerRejectionError</span><span class="p">,</span>
    <span class="n">ScrollRandomActivityError</span><span class="p">,</span>
    <span class="c1"># SlippageTooHighError, # Not directly detectable pre-swap with this ABI</span>
<span class="p">)</span>

<span class="c1"># Configure logging for this module</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># Contract addresses from architecture / config</span>
<span class="n">SCROLL_L1_GATEWAY_ROUTER_ADDRESS</span> <span class="o">=</span> \
    <span class="n">shared_config</span><span class="o">.</span><span class="n">SCROLL_L1_GATEWAY_ROUTER_ADDRESS</span>
<span class="n">SCROLL_L2_GATEWAY_ROUTER_ADDRESS</span> <span class="o">=</span> \
    <span class="n">shared_config</span><span class="o">.</span><span class="n">SCROLL_L2_GATEWAY_ROUTER_ADDRESS</span>
<span class="n">SCROLL_L1_GAS_ORACLE_ADDRESS</span> <span class="o">=</span> \
    <span class="n">shared_config</span><span class="o">.</span><span class="n">SCROLL_L1_GAS_ORACLE_ADDRESS</span>
<span class="n">SCROLL_L2_GAS_ORACLE_ADDRESS</span> <span class="o">=</span> \
    <span class="n">shared_config</span><span class="o">.</span><span class="n">SCROLL_L2_GAS_ORACLE_ADDRESS</span>
<span class="n">SYNC_SWAP_ROUTER_ADDRESS_SCROLL</span> <span class="o">=</span> \
    <span class="n">shared_config</span><span class="o">.</span><span class="n">SYNC_SWAP_ROUTER_ADDRESS_SCROLL</span>
<span class="n">SYNC_SWAP_CLASSIC_POOL_FACTORY_ADDRESS_SCROLL</span> <span class="o">=</span> \
    <span class="n">shared_config</span><span class="o">.</span><span class="n">SYNC_SWAP_CLASSIC_POOL_FACTORY_ADDRESS_SCROLL</span>

<span class="c1"># LayerBank V2 Configuration</span>
<span class="n">LAYERBANK_COMPTROLLER_ADDRESS_SCROLL</span> <span class="o">=</span> \
    <span class="n">shared_config</span><span class="o">.</span><span class="n">LAYERBANK_COMPTROLLER_ADDRESS_SCROLL</span>
<span class="n">LAYERBANK_PRICE_ORACLE_ADDRESS_SCROLL</span> <span class="o">=</span> \
    <span class="n">shared_config</span><span class="o">.</span><span class="n">LAYERBANK_PRICE_ORACLE_ADDRESS_SCROLL</span>
<span class="n">LAYERBANK_LBETH_ADDRESS_SCROLL</span> <span class="o">=</span> \
    <span class="n">shared_config</span><span class="o">.</span><span class="n">LAYERBANK_LBETH_ADDRESS_SCROLL</span>
<span class="n">LAYERBANK_LBUSDC_ADDRESS_SCROLL</span> <span class="o">=</span> \
    <span class="n">shared_config</span><span class="o">.</span><span class="n">LAYERBANK_LBUSDC_ADDRESS_SCROLL</span>
<span class="n">SCROLL_USDC_TOKEN_ADDRESS</span> <span class="o">=</span> \
    <span class="n">shared_config</span><span class="o">.</span><span class="n">SCROLL_USDC_TOKEN_ADDRESS</span>

<span class="c1"># ABI Names</span>
<span class="n">L1_GATEWAY_ROUTER_ABI_NAME</span> <span class="o">=</span> <span class="s2">&quot;L1GatewayRouter&quot;</span>
<span class="n">L2_GATEWAY_ROUTER_ABI_NAME</span> <span class="o">=</span> <span class="s2">&quot;L2GatewayRouter&quot;</span>
<span class="n">ERC20_ABI_NAME</span> <span class="o">=</span> <span class="s2">&quot;ERC20&quot;</span>
<span class="n">SYNC_SWAP_ROUTER_ABI_NAME</span> <span class="o">=</span> <span class="s2">&quot;SyncSwapRouter&quot;</span>
<span class="n">LAYERBANK_COMPTROLLER_ABI_NAME</span> <span class="o">=</span> <span class="s2">&quot;LayerBankComptroller&quot;</span>
<span class="n">LAYERBANK_LBTOKEN_ABI_NAME</span> <span class="o">=</span> <span class="s2">&quot;LayerBankLbToken&quot;</span>
<div class="viewcode-block" id="provide_liquidity_scroll">
<a class="viewcode-back" href="../../../../protocols.html#airdrops.protocols.scroll.scroll.provide_liquidity_scroll">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">provide_liquidity_scroll</span><span class="p">(</span>  <span class="c1"># noqa: E302</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># &quot;add&quot; or &quot;remove&quot;</span>
    <span class="n">token_a_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token_b_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">amount_a_desired</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">amount_b_desired</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lp_token_amount</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">slippage_percent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">deadline_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1800</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adds or removes liquidity for a token pair on SyncSwap on Scroll.</span>

<span class="sd">    Args:</span>
<span class="sd">        web3_scroll: Web3 instance for Scroll L2.</span>
<span class="sd">        private_key: Private key of the account.</span>
<span class="sd">        action: &quot;add&quot; to add liquidity, &quot;remove&quot; to remove liquidity.</span>
<span class="sd">        token_a_symbol: Symbol of the first token (e.g., &quot;ETH&quot;, &quot;USDC&quot;).</span>
<span class="sd">        token_b_symbol: Symbol of the second token (e.g., &quot;USDC&quot;, &quot;WETH&quot;).</span>
<span class="sd">        amount_a_desired: Desired amount of token_a to add (smallest unit).</span>
<span class="sd">            Required for &quot;add&quot;.</span>
<span class="sd">        amount_b_desired: Desired amount of token_b to add (smallest unit).</span>
<span class="sd">            Required for &quot;add&quot;.</span>
<span class="sd">        lp_token_amount: Amount of LP tokens to remove (smallest unit).</span>
<span class="sd">            Required for &quot;remove&quot;.</span>
<span class="sd">        slippage_percent: Allowed slippage percentage for calculating min amounts.</span>
<span class="sd">        deadline_seconds: Transaction deadline in seconds from now.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Transaction hash of the add/remove liquidity operation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        InsufficientLiquidityError: For pool not found or insufficient liquidity.</span>
<span class="sd">        InsufficientBalanceError: If balances are insufficient.</span>
<span class="sd">        ApprovalError: If token approval fails.</span>
<span class="sd">        TransactionRevertedError: If the transaction is reverted.</span>
<span class="sd">        ValueError: For invalid inputs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Resolve token addresses</span>
    <span class="n">token_a_address</span> <span class="o">=</span> <span class="n">_get_l2_token_address_scroll</span><span class="p">(</span><span class="n">token_a_symbol</span><span class="p">)</span>
    <span class="n">token_b_address</span> <span class="o">=</span> <span class="n">_get_l2_token_address_scroll</span><span class="p">(</span><span class="n">token_b_symbol</span><span class="p">)</span>
    <span class="n">weth_address</span> <span class="o">=</span> <span class="n">_get_l2_token_address_scroll</span><span class="p">(</span><span class="n">WETH_SYMBOL</span><span class="p">)</span>

    <span class="c1"># Get pool address</span>
    <span class="n">pool_address</span> <span class="o">=</span> <span class="n">_get_syncswap_pool_address_scroll</span><span class="p">(</span>
        <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">token_a_address</span><span class="p">,</span> <span class="n">token_b_address</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">pool_address</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No pool found for token pair </span><span class="si">{</span><span class="n">token_a_symbol</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">token_b_symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pool_address</span> <span class="o">==</span> <span class="n">ZERO_ADDRESS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InsufficientLiquidityError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No pool found for </span><span class="si">{</span><span class="n">token_a_symbol</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">token_b_symbol</span><span class="si">}</span><span class="s2"> on SyncSwap.&quot;</span>
        <span class="p">)</span>

    <span class="n">router_contract</span> <span class="o">=</span> <span class="n">_get_syncswap_router_contract_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">amount_a_desired</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">amount_b_desired</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Both amount_a_desired and amount_b_desired are required &quot;</span>
                <span class="s2">&quot;for adding liquidity.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Calculate minLiquidity (LP tokens) for slippage</span>
        <span class="n">min_liquidity</span> <span class="o">=</span> <span class="n">_calculate_min_liquidity_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">pool_address</span><span class="p">,</span> <span class="n">amount_a_desired</span><span class="p">,</span>
            <span class="n">amount_b_desired</span><span class="p">,</span> <span class="n">slippage_percent</span>
        <span class="p">)</span>

        <span class="c1"># Prepare TokenInput array</span>
        <span class="n">token_inputs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">msg_value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Token A</span>
        <span class="k">if</span> <span class="n">token_a_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
            <span class="n">token_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">weth_address</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount_a_desired</span><span class="p">})</span>
            <span class="n">msg_value</span> <span class="o">+=</span> <span class="n">amount_a_desired</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">token_a_address</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount_a_desired</span><span class="p">})</span>
            <span class="n">_approve_erc20_scroll</span><span class="p">(</span>
                <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">token_a_address</span><span class="p">,</span>
                <span class="n">SYNC_SWAP_ROUTER_ADDRESS_SCROLL</span><span class="p">,</span> <span class="n">amount_a_desired</span>
            <span class="p">)</span>
        <span class="c1"># Token B</span>
        <span class="k">if</span> <span class="n">token_b_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
            <span class="n">token_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">weth_address</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount_b_desired</span><span class="p">})</span>
            <span class="n">msg_value</span> <span class="o">+=</span> <span class="n">amount_b_desired</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">token_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">token_b_address</span><span class="p">,</span> <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount_b_desired</span><span class="p">})</span>
            <span class="n">_approve_erc20_scroll</span><span class="p">(</span>
                <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">token_b_address</span><span class="p">,</span>
                <span class="n">SYNC_SWAP_ROUTER_ADDRESS_SCROLL</span><span class="p">,</span> <span class="n">amount_b_desired</span>
            <span class="p">)</span>

        <span class="c1"># Call addLiquidity</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tx_params</span> <span class="o">=</span> <span class="n">router_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">addLiquidity</span><span class="p">(</span>
                <span class="n">pool_address</span><span class="p">,</span>
                <span class="n">token_inputs</span><span class="p">,</span>
                <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">min_liquidity</span><span class="p">,</span>
                <span class="n">ZERO_ADDRESS</span><span class="p">,</span>
                <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({</span>
                <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">Wei</span><span class="p">(</span><span class="n">msg_value</span><span class="p">),</span>
            <span class="p">})</span>
            <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span>
                <span class="n">web3_scroll</span><span class="p">,</span>
                <span class="n">private_key</span><span class="p">,</span>
                <span class="n">tx_params</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;addLiquidity failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">TransactionRevertedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;addLiquidity failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tx_hash</span>  <span class="c1"># noqa: E501</span>

    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">lp_token_amount</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;lp_token_amount is required for removing liquidity.&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate min amounts out for slippage</span>
        <span class="n">amount_a_min</span><span class="p">,</span> <span class="n">amount_b_min</span> <span class="o">=</span> <span class="n">_calculate_min_amounts_out_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">pool_address</span><span class="p">,</span> <span class="n">lp_token_amount</span><span class="p">,</span> <span class="n">slippage_percent</span>
        <span class="p">)</span>

        <span class="c1"># Approve LP tokens</span>
        <span class="n">_approve_erc20_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">pool_address</span><span class="p">,</span>
            <span class="n">SYNC_SWAP_ROUTER_ADDRESS_SCROLL</span><span class="p">,</span> <span class="n">lp_token_amount</span>
        <span class="p">)</span>

        <span class="c1"># Call burnLiquidity</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tx_params</span> <span class="o">=</span> <span class="n">router_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">burnLiquidity</span><span class="p">(</span>
                <span class="n">pool_address</span><span class="p">,</span>
                <span class="n">lp_token_amount</span><span class="p">,</span>
                <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">[</span><span class="n">amount_a_min</span><span class="p">,</span> <span class="n">amount_b_min</span><span class="p">],</span>
                <span class="n">ZERO_ADDRESS</span><span class="p">,</span>
                <span class="sa">b</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">({})</span>
            <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span>
                <span class="n">web3_scroll</span><span class="p">,</span>
                <span class="n">private_key</span><span class="p">,</span>
                <span class="n">tx_params</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;burnLiquidity failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">TransactionRevertedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;burnLiquidity failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tx_hash</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;action must be &#39;add&#39; or &#39;remove&#39;.&quot;</span><span class="p">)</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_calculate_min_liquidity_scroll</span><span class="p">(</span>  <span class="c1"># noqa: E302</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">pool_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">amount_a_desired</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">amount_b_desired</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">slippage_percent</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the minimum LP tokens to receive for add liquidity,</span>
<span class="sd">    applying slippage.</span>

<span class="sd">    Args:</span>
<span class="sd">        web3_scroll: Web3 instance.</span>
<span class="sd">        pool_address: Address of the SyncSwap pool.</span>
<span class="sd">        amount_a_desired: Desired amount of token A.</span>
<span class="sd">        amount_b_desired: Desired amount of token B.</span>
<span class="sd">        slippage_percent: Allowed slippage percentage.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Minimum LP tokens to receive.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pool_contract</span> <span class="o">=</span> <span class="n">_get_syncswap_classic_pool_contract_scroll</span><span class="p">(</span>
        <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">pool_address</span>
    <span class="p">)</span>
    <span class="n">reserves</span> <span class="o">=</span> <span class="n">pool_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getReserves</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
    <span class="n">total_supply</span> <span class="o">=</span> <span class="n">pool_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">totalSupply</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
    <span class="c1"># Simplified proportional calculation</span>
    <span class="k">if</span> <span class="n">total_supply</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># First liquidity provider</span>
        <span class="n">min_liquidity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="p">(</span><span class="n">amount_a_desired</span> <span class="o">+</span> <span class="n">amount_b_desired</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">slippage_percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_liquidity</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
            <span class="nb">min</span><span class="p">(</span>
                <span class="n">amount_a_desired</span> <span class="o">*</span> <span class="n">total_supply</span> <span class="o">//</span> <span class="n">reserves</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">amount_b_desired</span> <span class="o">*</span> <span class="n">total_supply</span> <span class="o">//</span> <span class="n">reserves</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">slippage_percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">min_liquidity</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_calculate_min_amounts_out_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">pool_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">lp_token_amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">slippage_percent</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate minimum amounts of tokens to receive when removing liquidity.</span>

<span class="sd">    Args:</span>
<span class="sd">        web3_scroll: Web3 instance.</span>
<span class="sd">        pool_address: Address of the SyncSwap pool.</span>
<span class="sd">        lp_token_amount: Amount of LP tokens to burn.</span>
<span class="sd">        slippage_percent: Allowed slippage percentage.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (amount_a_min, amount_b_min).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pool_contract</span> <span class="o">=</span> <span class="n">_get_syncswap_classic_pool_contract_scroll</span><span class="p">(</span>
        <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">pool_address</span>
    <span class="p">)</span>
    <span class="n">reserves</span> <span class="o">=</span> <span class="n">pool_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getReserves</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
    <span class="n">total_supply</span> <span class="o">=</span> <span class="n">pool_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">totalSupply</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
    <span class="n">amount_a_out_expected</span> <span class="o">=</span> <span class="n">lp_token_amount</span> <span class="o">*</span> <span class="n">reserves</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">total_supply</span>
    <span class="n">amount_b_out_expected</span> <span class="o">=</span> <span class="n">lp_token_amount</span> <span class="o">*</span> <span class="n">reserves</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">total_supply</span>
    <span class="n">amount_a_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount_a_out_expected</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">slippage_percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
    <span class="n">amount_b_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount_b_out_expected</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">slippage_percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">amount_a_min</span><span class="p">,</span> <span class="n">amount_b_min</span>


<span class="n">SYNC_SWAP_CLASSIC_POOL_FACTORY_ABI_NAME</span> <span class="o">=</span> <span class="s2">&quot;SyncSwapClassicPoolFactory&quot;</span>
<span class="n">SYNC_SWAP_CLASSIC_POOL_ABI_NAME</span> <span class="o">=</span> <span class="s2">&quot;SyncSwapClassicPool&quot;</span>

<span class="c1"># Default gas limits and constants</span>
<span class="n">DEFAULT_L2_GAS_LIMIT</span> <span class="o">=</span> <span class="mi">200000</span>  <span class="c1"># For bridging</span>
<span class="n">DEFAULT_SWAP_L2_GAS_LIMIT</span> <span class="o">=</span> <span class="mi">600000</span>
<span class="n">DEFAULT_GAS_MULTIPLIER</span> <span class="o">=</span> <span class="mf">1.2</span>
<span class="n">MAX_RETRIES</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">RETRY_DELAY_SECONDS</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">ZERO_ADDRESS</span> <span class="o">=</span> <span class="s2">&quot;0x0000000000000000000000000000000000000000&quot;</span>
<span class="n">ETH_SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;ETH&quot;</span>
<span class="n">WETH_SYMBOL</span> <span class="o">=</span> <span class="s2">&quot;WETH&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_load_abi_scroll</span><span class="p">(</span><span class="n">contract_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load ABI JSON from the abi directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        contract_name: Name of the contract (e.g., &#39;L1GatewayRouter&#39;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        ABI as a list of dictionaries</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If ABI file doesn&#39;t exist</span>
<span class="sd">        json.JSONDecodeError: If ABI file is invalid JSON</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">abi_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;abi&quot;</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">contract_name</span><span class="si">}</span><span class="s2">.json&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">abi_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ABI file not found: </span><span class="si">{</span><span class="n">abi_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ABI file not found: </span><span class="si">{</span><span class="n">abi_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON in ABI file </span><span class="si">{</span><span class="n">abi_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid JSON in ABI file </span><span class="si">{</span><span class="n">abi_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">pos</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_account_scroll</span><span class="p">(</span><span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">web3_instance</span><span class="p">:</span> <span class="n">Web3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LocalAccount</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create Account object from private key.</span>

<span class="sd">    Args:</span>
<span class="sd">        private_key: Private key string</span>
<span class="sd">        web3_instance: Web3  # (used for potential future validation, currently unused)</span>

<span class="sd">    Returns:</span>
<span class="sd">        Account object</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If private key is invalid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">private_key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span><span class="p">):</span>
            <span class="n">private_key</span> <span class="o">=</span> <span class="s2">&quot;0x&quot;</span> <span class="o">+</span> <span class="n">private_key</span>
        <span class="n">account</span><span class="p">:</span> <span class="n">LocalAccount</span> <span class="o">=</span> <span class="n">Account</span><span class="o">.</span><span class="n">from_key</span><span class="p">(</span><span class="n">private_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">account</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid private key provided: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid private key: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_l2_token_address_scroll</span><span class="p">(</span><span class="n">token_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get L2 address for a token symbol from shared config.</span>

<span class="sd">    Args:</span>
<span class="sd">        token_symbol: Token symbol (e.g., &quot;ETH&quot;, &quot;WETH&quot;, &quot;USDC&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        L2 token address as a string.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TokenNotSupportedError: If token symbol is not configured or L2 address</span>
<span class="sd">            is missing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">token_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shared_config</span><span class="o">.</span><span class="n">SCROLL_TOKEN_ADDRESSES</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token symbol &#39;</span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2">&#39; not found in configuration.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">TokenNotSupportedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Token symbol &#39;</span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2">&#39; not supported.&quot;</span><span class="p">)</span>
    <span class="n">token_config_entry</span> <span class="o">=</span> <span class="n">shared_config</span><span class="o">.</span><span class="n">SCROLL_TOKEN_ADDRESSES</span><span class="p">[</span><span class="n">token_symbol</span><span class="p">]</span>
    <span class="c1"># Cast to Dict to help mypy understand .get() and indexing</span>
    <span class="n">token_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">token_config_entry</span><span class="p">)</span>
    <span class="n">l2_address</span> <span class="o">=</span> <span class="n">token_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;L2&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">l2_address</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">token_symbol</span> <span class="o">!=</span> <span class="n">ETH_SYMBOL</span>
    <span class="p">):</span>  <span class="c1"># ETH L2 is None, handled by WETH</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;L2 address for token &#39;</span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2">&#39; is not configured.&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">TokenNotSupportedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;L2 address for token &#39;</span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2">&#39; not configured.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># For ETH, we typically use WETH address in contracts</span>
    <span class="k">if</span> <span class="n">token_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
        <span class="n">weth_config_entry</span> <span class="o">=</span> <span class="n">shared_config</span><span class="o">.</span><span class="n">SCROLL_TOKEN_ADDRESSES</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">WETH_SYMBOL</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">weth_config_entry</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TokenNotSupportedError</span><span class="p">(</span>
                <span class="s2">&quot;WETH symbol not found in SCROLL_TOKEN_ADDRESSES.&quot;</span>
            <span class="p">)</span>
        <span class="n">weth_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">weth_config_entry</span><span class="p">)</span>
        <span class="n">weth_l2</span> <span class="o">=</span> <span class="n">weth_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;L2&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">weth_l2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TokenNotSupportedError</span><span class="p">(</span>
                <span class="s2">&quot;WETH L2 address not configured, required for ETH operations.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">weth_l2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">l2_address</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_contract_scroll</span><span class="p">(</span>
    <span class="n">web3_instance</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span> <span class="n">contract_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">contract_address</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Contract</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load ABI and return contract instance.</span>

<span class="sd">    Args:</span>
<span class="sd">        web3_instance: Web3 instance</span>
<span class="sd">        contract_name: Name of contract for ABI loading</span>
<span class="sd">        contract_address: Contract address</span>

<span class="sd">    Returns:</span>
<span class="sd">        Web3 Contract instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">abi</span> <span class="o">=</span> <span class="n">_load_abi_scroll</span><span class="p">(</span><span class="n">contract_name</span><span class="p">)</span>
    <span class="n">checksum_address</span> <span class="o">=</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">contract_address</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">web3_instance</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span><span class="n">address</span><span class="o">=</span><span class="n">checksum_address</span><span class="p">,</span> <span class="n">abi</span><span class="o">=</span><span class="n">abi</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_build_and_send_tx_scroll</span><span class="p">(</span>
    <span class="n">web3_instance</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span> <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">tx_params</span><span class="p">:</span> <span class="n">TxParams</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build, sign, send, and wait for a transaction, with retry logic for</span>
<span class="sd">    transient errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">_get_account_scroll</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">web3_instance</span><span class="p">)</span>
    <span class="n">tx_params</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span>
        <span class="s2">&quot;nonce&quot;</span><span class="p">,</span> <span class="n">web3_instance</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span><span class="n">account</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">tx_params</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;gasPrice&quot;</span><span class="p">,</span> <span class="n">web3_instance</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;gas&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tx_params</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">estimated_gas</span> <span class="o">=</span> <span class="n">web3_instance</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">estimate_gas</span><span class="p">(</span><span class="n">tx_params</span><span class="p">)</span>
            <span class="n">tx_params</span><span class="p">[</span><span class="s2">&quot;gas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Wei</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">estimated_gas</span> <span class="o">*</span> <span class="n">DEFAULT_GAS_MULTIPLIER</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimated gas: </span><span class="si">{</span><span class="n">estimated_gas</span><span class="si">}</span><span class="s2">, using: </span><span class="si">{</span><span class="n">tx_params</span><span class="p">[</span><span class="s1">&#39;gas&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gas estimation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">, tx_params: </span><span class="si">{</span><span class="n">tx_params</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Include address in log if available</span>
            <span class="n">from_address</span> <span class="o">=</span> <span class="n">tx_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;from&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="n">to_address</span> <span class="o">=</span> <span class="n">tx_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;to&quot;</span><span class="p">,</span> <span class="s2">&quot;N/A&quot;</span><span class="p">)</span>
            <span class="c1"># Convert bytes to string if needed for logging</span>
            <span class="n">from_addr_str</span> <span class="o">=</span> <span class="n">from_address</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">from_address</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_address</span><span class="p">)</span>
            <span class="n">to_addr_str</span> <span class="o">=</span> <span class="n">to_address</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">to_address</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">to_address</span><span class="p">)</span>
            <span class="n">data_present</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span> <span class="ow">in</span> <span class="n">tx_params</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Gas estimation failed for tx from </span><span class="si">{</span><span class="n">from_addr_str</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">to_addr_str</span><span class="si">}</span><span class="s2"> &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(data present: </span><span class="si">{</span><span class="n">data_present</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">!s}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">ContractLogicError</span><span class="p">):</span>  <span class="c1"># More specific error</span>
                <span class="k">raise</span> <span class="n">GasEstimationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Gas estimation failed due to contract logic: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2"> - &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Data: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="n">GasEstimationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gas estimation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">signed</span> <span class="o">=</span> <span class="n">web3_instance</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span><span class="n">tx_params</span><span class="p">,</span> <span class="n">private_key</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction signing failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">TransactionBuildError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction signing failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">last_exception</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MAX_RETRIES</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">MAX_RETRIES</span><span class="si">}</span><span class="s2"> to send transaction...&quot;</span>
            <span class="p">)</span>
            <span class="n">tx_hash_bytes</span> <span class="o">=</span> <span class="n">web3_instance</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">send_raw_transaction</span><span class="p">(</span>
                <span class="n">signed</span><span class="o">.</span><span class="n">raw_transaction</span>
            <span class="p">)</span>
            <span class="n">tx_hash_hex</span> <span class="o">=</span> <span class="n">tx_hash_bytes</span><span class="o">.</span><span class="n">hex</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction sent with hash: </span><span class="si">{</span><span class="n">tx_hash_hex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting for transaction receipt for </span><span class="si">{</span><span class="n">tx_hash_hex</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="n">receipt</span><span class="p">:</span> <span class="n">TxReceipt</span> <span class="o">=</span> <span class="n">web3_instance</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">wait_for_transaction_receipt</span><span class="p">(</span>
                <span class="n">tx_hash_bytes</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">180</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction receipt received for </span><span class="si">{</span><span class="n">tx_hash_hex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">receipt</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Transaction </span><span class="si">{</span><span class="n">tx_hash_hex</span><span class="si">}</span><span class="s2"> reverted. Receipt status: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">receipt</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">raise</span> <span class="n">TransactionRevertedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Transaction </span><span class="si">{</span><span class="n">tx_hash_hex</span><span class="si">}</span><span class="s2"> reverted.&quot;</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="n">receipt</span>
                <span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Transaction </span><span class="si">{</span><span class="n">tx_hash_hex</span><span class="si">}</span><span class="s2"> successful.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">tx_hash_hex</span>

        <span class="k">except</span> <span class="p">(</span><span class="ne">ConnectionError</span><span class="p">,</span> <span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># Added TimeoutError</span>
            <span class="n">last_exception</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">MAX_RETRIES</span><span class="si">}</span><span class="s2"> failed due to RPC/network &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;issue: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Retrying in </span><span class="si">{</span><span class="n">RETRY_DELAY_SECONDS</span><span class="si">}</span><span class="s2">s...&quot;</span>
            <span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">RETRY_DELAY_SECONDS</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">MAX_RETRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_nonce</span> <span class="o">=</span> <span class="n">web3_instance</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_transaction_count</span><span class="p">(</span>
                        <span class="n">account</span><span class="o">.</span><span class="n">address</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">current_nonce</span> <span class="o">&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">tx_params</span><span class="p">[</span><span class="s2">&quot;nonce&quot;</span><span class="p">]):</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Nonce already used or too low. Current: </span><span class="si">{</span><span class="n">current_nonce</span><span class="si">}</span><span class="s2">, &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Tx: </span><span class="si">{</span><span class="n">tx_params</span><span class="p">[</span><span class="s1">&#39;nonce&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">. Updating nonce.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">tx_params</span><span class="p">[</span><span class="s2">&quot;nonce&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">current_nonce</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Nonce </span><span class="si">{</span><span class="n">tx_params</span><span class="p">[</span><span class="s1">&#39;nonce&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> seems still valid or higher. &quot;</span>
                            <span class="sa">f</span><span class="s2">&quot;Current: </span><span class="si">{</span><span class="n">current_nonce</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span>

                    <span class="n">signed</span> <span class="o">=</span> <span class="n">web3_instance</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">account</span><span class="o">.</span><span class="n">sign_transaction</span><span class="p">(</span>
                        <span class="n">tx_params</span><span class="p">,</span> <span class="n">private_key</span>
                    <span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Re-signed transaction with nonce </span><span class="si">{</span><span class="n">tx_params</span><span class="p">[</span><span class="s1">&#39;nonce&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;for retry.&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">sign_e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Transaction re-signing failed before retry: </span><span class="si">{</span><span class="n">sign_e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="c1"># Not raising here, let the outer loop decide if it&#39;s max retries</span>
                    <span class="n">last_exception</span> <span class="o">=</span> <span class="n">TransactionBuildError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Transaction re-signing failed before retry: </span><span class="si">{</span><span class="n">sign_e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">break</span>
        <span class="k">except</span> <span class="n">TransactionRevertedError</span><span class="p">:</span>
            <span class="k">raise</span>  <span class="c1"># Re-raise if already specific</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">last_exception</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during transaction processing &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;(attempt </span><span class="si">{</span><span class="n">attempt</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">&lt;</span> <span class="n">MAX_RETRIES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">RETRY_DELAY_SECONDS</span><span class="p">)</span>

    <span class="c1"># After loop</span>
    <span class="k">if</span> <span class="n">last_exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;All </span><span class="si">{</span><span class="n">MAX_RETRIES</span><span class="si">}</span><span class="s2"> attempts failed. Last error: </span><span class="si">{</span><span class="n">last_exception</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_exception</span><span class="p">,</span> <span class="p">(</span><span class="ne">ConnectionError</span><span class="p">,</span> <span class="ne">TimeoutError</span><span class="p">,</span> <span class="n">Timeout</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="n">MaxRetriesExceededError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Transaction failed after </span><span class="si">{</span><span class="n">MAX_RETRIES</span><span class="si">}</span><span class="s2"> attempts due to &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;RPC/network issues: </span><span class="si">{</span><span class="n">last_exception</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_exception</span><span class="p">,</span> <span class="n">TransactionRevertedError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">last_exception</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_exception</span><span class="p">,</span> <span class="n">TransactionBuildError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">last_exception</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TransactionSendError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to send/confirm transaction after </span><span class="si">{</span><span class="n">MAX_RETRIES</span><span class="si">}</span><span class="s2"> retries: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">last_exception</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Should ideally not be reached if logic is correct</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s2">&quot;Transaction processing finished in an unexpected state (no success, &quot;</span>
        <span class="s2">&quot;no explicit error after retries).&quot;</span>
    <span class="p">)</span>
    <span class="k">raise</span> <span class="n">ScrollBridgeError</span><span class="p">(</span>
        <span class="s2">&quot;Transaction processing finished in an unexpected state after retries.&quot;</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_approve_erc20_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">spender_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Approve ERC20 token for spending by a spender on Scroll L2.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Approving </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> of token </span><span class="si">{</span><span class="n">token_address</span><span class="si">}</span><span class="s2"> for spender </span><span class="si">{</span><span class="n">spender_address</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">account</span> <span class="o">=</span> <span class="n">_get_account_scroll</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">web3_scroll</span><span class="p">)</span>
    <span class="n">contract</span> <span class="o">=</span> <span class="n">_get_contract_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">ERC20_ABI_NAME</span><span class="p">,</span> <span class="n">token_address</span><span class="p">)</span>

    <span class="c1"># Check current allowance</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">current_allowance</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">allowance</span><span class="p">(</span>
            <span class="n">account</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">spender_address</span>
        <span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">current_allowance</span> <span class="o">&gt;=</span> <span class="n">amount</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Allowance of </span><span class="si">{</span><span class="n">current_allowance</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">spender_address</span><span class="si">}</span><span class="s2"> is &quot;</span>
                <span class="s2">&quot;sufficient. Skipping approval.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;existing_approval_sufficient_for_</span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not check current allowance for </span><span class="si">{</span><span class="n">token_address</span><span class="si">}</span><span class="s2"> to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">spender_address</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Proceeding with approval.&quot;</span>
        <span class="p">)</span>

    <span class="n">tx_dict_approve</span><span class="p">:</span> <span class="n">TxParams</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">account</span><span class="o">.</span><span class="n">address</span><span class="p">,</span>
        <span class="s2">&quot;gasPrice&quot;</span><span class="p">:</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">approve_tx</span> <span class="o">=</span> <span class="n">contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">approve</span><span class="p">(</span>
            <span class="n">spender_address</span><span class="p">,</span> <span class="n">amount</span>
        <span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span><span class="n">tx_dict_approve</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;to&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">approve_tx</span><span class="p">:</span>
            <span class="n">approve_tx</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">token_address</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Built approval transaction: </span><span class="si">{</span><span class="n">approve_tx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">approve_tx</span><span class="p">)</span>

    <span class="k">except</span> <span class="n">GasEstimationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gas estimation failed for ERC20 approval: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ApprovalError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERC20 approval gas estimation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">except</span> <span class="n">TransactionRevertedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERC20 approval transaction reverted: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">receipt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ApprovalError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;ERC20 approval failed: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">receipt</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">receipt</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERC20 approval error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ApprovalError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERC20 approval error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_estimate_l1_to_l2_message_fee_scroll</span><span class="p">(</span>
    <span class="n">web3_l1</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span> <span class="n">l2_gas_limit</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">l2_gas_price</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Estimate the L1-&gt;L2 message fee using the Scroll L1 Gas Oracle.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">oracle_abi</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;internalType&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;gasLimit&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">],</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;estimateCrossDomainMessageFee&quot;</span><span class="p">,</span>
                <span class="s2">&quot;outputs&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;internalType&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;uint256&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">],</span>
                <span class="s2">&quot;stateMutability&quot;</span><span class="p">:</span> <span class="s2">&quot;view&quot;</span><span class="p">,</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;function&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">]</span>
        <span class="n">oracle</span> <span class="o">=</span> <span class="n">web3_l1</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">contract</span><span class="p">(</span>
            <span class="n">address</span><span class="o">=</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">SCROLL_L1_GAS_ORACLE_ADDRESS</span><span class="p">),</span>
            <span class="n">abi</span><span class="o">=</span><span class="n">oracle_abi</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fee</span> <span class="o">=</span> <span class="n">oracle</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">estimateCrossDomainMessageFee</span><span class="p">(</span><span class="n">l2_gas_limit</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">fee</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to estimate L1-&gt;L2 message fee: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">GasEstimationError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to estimate L1-&gt;L2 message fee: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="c1"># --- Swap Specific Helpers ---</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_syncswap_classic_pool_factory_contract_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Contract</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the SyncSwap Classic Pool Factory contract instance.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
        <span class="n">web3_scroll</span><span class="p">,</span>
        <span class="n">SYNC_SWAP_CLASSIC_POOL_FACTORY_ABI_NAME</span><span class="p">,</span>
        <span class="n">SYNC_SWAP_CLASSIC_POOL_FACTORY_ADDRESS_SCROLL</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_syncswap_pool_address_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span> <span class="n">token0_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">token1_address</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get pool address for a token pair using SyncSwap Classic Pool Factory.&quot;&quot;&quot;</span>
    <span class="n">factory</span> <span class="o">=</span> <span class="n">_get_syncswap_classic_pool_factory_contract_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Ensure addresses are checksummed for contract calls</span>
        <span class="n">token0_checksum</span> <span class="o">=</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token0_address</span><span class="p">)</span>
        <span class="n">token1_checksum</span> <span class="o">=</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token1_address</span><span class="p">)</span>

        <span class="c1"># Order of tokens might matter for getPool, typically sorted</span>
        <span class="c1"># (token0, token1) = sorted((token0_checksum, token1_checksum))</span>
        <span class="c1"># For SyncSwap, it seems to handle unsorted pairs too. Let&#39;s try direct.</span>
        <span class="n">pool_address_any</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getPool</span><span class="p">(</span>
            <span class="n">token0_checksum</span><span class="p">,</span> <span class="n">token1_checksum</span>
        <span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">pool_address</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pool_address_any</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pool_address</span> <span class="o">==</span> <span class="n">ZERO_ADDRESS</span><span class="p">:</span>
            <span class="c1"># Try reverse order if the factory doesn&#39;t sort internally</span>
            <span class="n">pool_address_reversed_any</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getPool</span><span class="p">(</span>
                <span class="n">token1_checksum</span><span class="p">,</span> <span class="n">token0_checksum</span>
            <span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
            <span class="n">pool_address_reversed</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">pool_address_reversed_any</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pool_address_reversed</span> <span class="o">!=</span> <span class="n">ZERO_ADDRESS</span><span class="p">:</span>
                <span class="c1"># DEBUG: _get_syncswap_pool_address_scroll - pool_address_reversed</span>
                <span class="k">return</span> <span class="n">pool_address_reversed</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;No SyncSwap Classic pool found for </span><span class="si">{</span><span class="n">token0_address</span><span class="si">}</span><span class="s2"> and &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token1_address</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># DEBUG: _get_syncswap_pool_address_scroll - pool_address</span>
        <span class="k">return</span> <span class="n">pool_address</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Error getting pool for </span><span class="si">{</span><span class="n">token0_address</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">token1_address</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_syncswap_classic_pool_contract_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span> <span class="n">pool_address</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Contract</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get a SyncSwap Classic Pool contract instance given its address.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
        <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">SYNC_SWAP_CLASSIC_POOL_ABI_NAME</span><span class="p">,</span> <span class="n">pool_address</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_syncswap_router_contract_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Contract</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the SyncSwap Router contract instance.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
        <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">SYNC_SWAP_ROUTER_ABI_NAME</span><span class="p">,</span> <span class="n">SYNC_SWAP_ROUTER_ADDRESS_SCROLL</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_expected_amount_out_syncswap_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">token_in_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token_out_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">amount_in</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">sender_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># EOA address for the call context</span>
    <span class="n">weth_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the expected output amount for a swap.</span>
<span class="sd">    Tries direct pool, then via WETH if applicable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Getting expected amount out for </span><span class="si">{</span><span class="n">amount_in</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">token_in_address</span><span class="si">}</span><span class="s2"> to &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token_out_address</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Try direct pool</span>
    <span class="n">direct_pool_address</span> <span class="o">=</span> <span class="n">_get_syncswap_pool_address_scroll</span><span class="p">(</span>
        <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">token_in_address</span><span class="p">,</span> <span class="n">token_out_address</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">direct_pool_address</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pool_contract</span> <span class="o">=</span> <span class="n">_get_syncswap_classic_pool_contract_scroll</span><span class="p">(</span>
                <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">direct_pool_address</span>
            <span class="p">)</span>
            <span class="n">expected_out</span> <span class="o">=</span> <span class="n">pool_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getAmountOut</span><span class="p">(</span>
                <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_in_address</span><span class="p">),</span>
                <span class="n">amount_in</span><span class="p">,</span>
                <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">sender_address</span><span class="p">),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
            <span class="c1"># DEBUG: _get_expected_amount_out_syncswap_scroll - expected_out</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Direct pool </span><span class="si">{</span><span class="n">direct_pool_address</span><span class="si">}</span><span class="s2"> quote: </span><span class="si">{</span><span class="n">expected_out</span><span class="si">}</span><span class="s2"> of &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token_out_address</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">expected_out</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Failed to get quote from direct pool </span><span class="si">{</span><span class="n">direct_pool_address</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># Try via WETH if token_in and token_out are not WETH and not ETH</span>
    <span class="c1"># (ETH is handled as WETH internally)</span>
    <span class="k">if</span> <span class="n">token_in_address</span> <span class="o">!=</span> <span class="n">weth_address</span> <span class="ow">and</span> <span class="n">token_out_address</span> <span class="o">!=</span> <span class="n">weth_address</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No direct pool, trying via WETH (</span><span class="si">{</span><span class="n">weth_address</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">pool1_address</span> <span class="o">=</span> <span class="n">_get_syncswap_pool_address_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">token_in_address</span><span class="p">,</span> <span class="n">weth_address</span>
        <span class="p">)</span>
        <span class="n">pool2_address</span> <span class="o">=</span> <span class="n">_get_syncswap_pool_address_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">weth_address</span><span class="p">,</span> <span class="n">token_out_address</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">pool1_address</span> <span class="ow">and</span> <span class="n">pool2_address</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">pool1_contract</span> <span class="o">=</span> <span class="n">_get_syncswap_classic_pool_contract_scroll</span><span class="p">(</span>
                    <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">pool1_address</span>
                <span class="p">)</span>
                <span class="n">amount_weth_out</span> <span class="o">=</span> <span class="n">pool1_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getAmountOut</span><span class="p">(</span>
                    <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_in_address</span><span class="p">),</span>
                    <span class="n">amount_in</span><span class="p">,</span>
                    <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">sender_address</span><span class="p">),</span>
                <span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Pool1 (</span><span class="si">{</span><span class="n">token_in_address</span><span class="si">}</span><span class="s2">-&gt;WETH) quote: </span><span class="si">{</span><span class="n">amount_weth_out</span><span class="si">}</span><span class="s2"> WETH&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">amount_weth_out</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">InsufficientLiquidityError</span><span class="p">(</span>
                        <span class="s2">&quot;First leg of WETH hop (token_in -&gt; WETH) results in 0 output.&quot;</span>
                    <span class="p">)</span>

                <span class="n">pool2_contract</span> <span class="o">=</span> <span class="n">_get_syncswap_classic_pool_contract_scroll</span><span class="p">(</span>
                    <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">pool2_address</span>
                <span class="p">)</span>
                <span class="n">final_amount_out</span> <span class="o">=</span> <span class="n">pool2_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getAmountOut</span><span class="p">(</span>
                    <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">weth_address</span><span class="p">),</span>
                    <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">amount_weth_out</span><span class="p">),</span>
                    <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">sender_address</span><span class="p">),</span>
                <span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
                <span class="c1"># DEBUG: _get_expected_amount_out_syncswap_scroll - final_amount_out</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Pool2 (WETH-&gt;</span><span class="si">{</span><span class="n">token_out_address</span><span class="si">}</span><span class="s2">) quote: </span><span class="si">{</span><span class="n">final_amount_out</span><span class="si">}</span><span class="s2"> &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token_out_address</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">final_amount_out</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get quote via WETH hop: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Could not find a valid path or pool for swapping </span><span class="si">{</span><span class="n">token_in_address</span><span class="si">}</span><span class="s2"> to &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token_out_address</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">raise</span> <span class="n">InsufficientLiquidityError</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;No liquidity or path found for swapping </span><span class="si">{</span><span class="n">token_in_address</span><span class="si">}</span><span class="s2"> to &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token_out_address</span><span class="si">}</span><span class="s2"> on SyncSwap.&quot;</span>
    <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_calculate_amount_out_min_syncswap_scroll</span><span class="p">(</span>
    <span class="n">expected_amount_out</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">slippage_percent</span><span class="p">:</span> <span class="nb">float</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate the minimum amount_out based on expected_amount_out and slippage.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">slippage_percent</span> <span class="o">&lt;=</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Slippage percent must be between 0 and 100.&quot;</span><span class="p">)</span>
    <span class="n">amount_out_min</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">expected_amount_out</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">slippage_percent</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Calculated amountOutMin: </span><span class="si">{</span><span class="n">amount_out_min</span><span class="si">}</span><span class="s2"> from expected &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expected_amount_out</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">slippage_percent</span><span class="si">}</span><span class="s2">% slippage&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">amount_out_min</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_encode_swap_step_data_scroll</span><span class="p">(</span>
    <span class="n">token_in_for_step</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">to_address_for_step</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">withdraw_mode</span><span class="p">:</span> <span class="nb">int</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HexBytes</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ABI encodes the data for a SwapStep.&quot;&quot;&quot;</span>
    <span class="c1"># (address tokenIn, address to, uint8 withdrawMode)</span>
    <span class="n">encoded_data</span> <span class="o">=</span> <span class="n">abi_encode</span><span class="p">(</span>
        <span class="p">[</span><span class="s2">&quot;address&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">,</span> <span class="s2">&quot;uint8&quot;</span><span class="p">],</span>
        <span class="p">[</span>
            <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_in_for_step</span><span class="p">),</span>
            <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">to_address_for_step</span><span class="p">),</span>
            <span class="n">withdraw_mode</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">HexBytes</span><span class="p">(</span><span class="n">encoded_data</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_construct_syncswap_paths_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">token_in_start_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># Initial token input to the whole swap</span>
    <span class="n">token_out_final_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># Final token output of the whole swap</span>
    <span class="n">amount_in_start</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">final_recipient_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">weth_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">router_contract</span><span class="p">:</span> <span class="n">Contract</span><span class="p">,</span>  <span class="c1"># Pass router to get vault address</span>
    <span class="n">actual_token_out_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># The symbol string like &quot;ETH&quot;, &quot;USDC&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Constructs the &#39;paths&#39; parameter for SyncSwap router&#39;s swap function.</span>
<span class="sd">    Handles direct (A-&gt;B) and single-hop via WETH (A-&gt;WETH-&gt;B).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Constructing SyncSwap path: </span><span class="si">{</span><span class="n">token_in_start_address</span><span class="si">}</span><span class="s2"> -&gt; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token_out_final_address</span><span class="si">}</span><span class="s2"> for amount </span><span class="si">{</span><span class="n">amount_in_start</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="c1"># DEBUG: _construct_syncswap_paths_scroll - token_in_start_address</span>
    <span class="c1"># DEBUG: _construct_syncswap_paths_scroll - token_out_final_address</span>
    <span class="c1"># DEBUG: _construct_syncswap_paths_scroll - amount_in_start</span>
    <span class="n">paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Get vault address from router - needed for intermediate steps</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vault_address</span> <span class="o">=</span> <span class="n">router_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">vault</span><span class="p">()</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="c1"># DEBUG: _construct_syncswap_paths_scroll - vault_address</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SyncSwap Vault address: </span><span class="si">{</span><span class="n">vault_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not fetch vault address from SyncSwap Router: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ScrollSwapError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not fetch vault address from SyncSwap Router: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Try direct path first: token_in_start_address -&gt; token_out_final_address</span>
    <span class="n">direct_pool_address</span> <span class="o">=</span> <span class="n">_get_syncswap_pool_address_scroll</span><span class="p">(</span>
        <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">token_in_start_address</span><span class="p">,</span> <span class="n">token_out_final_address</span>
    <span class="p">)</span>
    <span class="c1"># DEBUG: _construct_syncswap_paths_scroll - direct_pool_address</span>
    <span class="k">if</span> <span class="n">direct_pool_address</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Direct path found via pool: </span><span class="si">{</span><span class="n">direct_pool_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">withdraw_mode</span><span class="p">:</span> <span class="nb">int</span>
        <span class="k">if</span> <span class="n">actual_token_out_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>  <span class="c1"># Final output is native ETH</span>
            <span class="n">withdraw_mode</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">token_out_final_address</span> <span class="o">==</span> <span class="n">weth_address</span><span class="p">:</span>  <span class="c1"># Final output is WETH (ERC20)</span>
            <span class="n">withdraw_mode</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># Final output is other ERC20</span>
            <span class="n">withdraw_mode</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">step_data</span> <span class="o">=</span> <span class="n">_encode_swap_step_data_scroll</span><span class="p">(</span>
            <span class="n">token_in_start_address</span><span class="p">,</span> <span class="n">final_recipient_address</span><span class="p">,</span> <span class="n">withdraw_mode</span>
        <span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;pool&quot;</span><span class="p">:</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">direct_pool_address</span><span class="p">),</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">step_data</span><span class="p">,</span>
            <span class="s2">&quot;callback&quot;</span><span class="p">:</span> <span class="n">ZERO_ADDRESS</span><span class="p">,</span>
            <span class="s2">&quot;callbackData&quot;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span><span class="p">),</span>
        <span class="p">}</span>
        <span class="n">path_obj</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">step</span><span class="p">],</span>
            <span class="s2">&quot;tokenIn&quot;</span><span class="p">:</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_in_start_address</span><span class="p">),</span>
            <span class="s2">&quot;amountIn&quot;</span><span class="p">:</span> <span class="n">amount_in_start</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_obj</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">paths</span>

    <span class="c1"># If no direct path, try path via WETH (if applicable)</span>
    <span class="c1"># A -&gt; WETH -&gt; B (where A != WETH and B != WETH)</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">token_in_start_address</span> <span class="o">!=</span> <span class="n">weth_address</span>
        <span class="ow">and</span> <span class="n">token_out_final_address</span> <span class="o">!=</span> <span class="n">weth_address</span>
    <span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No direct path, trying via WETH: </span><span class="si">{</span><span class="n">token_in_start_address</span><span class="si">}</span><span class="s2"> -&gt; &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">weth_address</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">token_out_final_address</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">pool1_address</span> <span class="o">=</span> <span class="n">_get_syncswap_pool_address_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">token_in_start_address</span><span class="p">,</span> <span class="n">weth_address</span>
        <span class="p">)</span>
        <span class="c1"># DEBUG: _construct_syncswap_paths_scroll - pool1_address</span>
        <span class="n">pool2_address</span> <span class="o">=</span> <span class="n">_get_syncswap_pool_address_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">weth_address</span><span class="p">,</span> <span class="n">token_out_final_address</span>
        <span class="p">)</span>
        <span class="c1"># DEBUG: _construct_syncswap_paths_scroll - pool2_address</span>

        <span class="k">if</span> <span class="n">pool1_address</span> <span class="ow">and</span> <span class="n">pool2_address</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Found WETH hop: Pool1 (</span><span class="si">{</span><span class="n">token_in_start_address</span><span class="si">}</span><span class="s2">-&gt;WETH): &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pool1_address</span><span class="si">}</span><span class="s2">, Pool2 (WETH-&gt;</span><span class="si">{</span><span class="n">token_out_final_address</span><span class="si">}</span><span class="s2">): &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pool2_address</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">step1_data</span> <span class="o">=</span> <span class="n">_encode_swap_step_data_scroll</span><span class="p">(</span>
                <span class="n">token_in_start_address</span><span class="p">,</span> <span class="n">vault_address</span><span class="p">,</span> <span class="mi">2</span>  <span class="c1"># 2 = keep as WETH</span>
            <span class="p">)</span>
            <span class="n">step1</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;pool&quot;</span><span class="p">:</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">pool1_address</span><span class="p">),</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">step1_data</span><span class="p">,</span>
                <span class="s2">&quot;callback&quot;</span><span class="p">:</span> <span class="n">ZERO_ADDRESS</span><span class="p">,</span>
                <span class="s2">&quot;callbackData&quot;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span><span class="p">),</span>
            <span class="p">}</span>

            <span class="c1"># Step 2: WETH -&gt; token_out_final_address (output to final recipient)</span>
            <span class="n">final_withdraw_mode</span><span class="p">:</span> <span class="nb">int</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">actual_token_out_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span>
            <span class="p">):</span>  <span class="c1"># Should not happen if token_out_final_address != weth_address</span>
                <span class="n">final_withdraw_mode</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">elif</span> <span class="p">(</span>
                <span class="n">token_out_final_address</span> <span class="o">==</span> <span class="n">weth_address</span>
            <span class="p">):</span>  <span class="c1"># Should not happen due to outer if</span>
                <span class="n">final_withdraw_mode</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># Final output is other ERC20</span>
                <span class="n">final_withdraw_mode</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">step2_data</span> <span class="o">=</span> <span class="n">_encode_swap_step_data_scroll</span><span class="p">(</span>
                <span class="n">weth_address</span><span class="p">,</span> <span class="n">final_recipient_address</span><span class="p">,</span> <span class="n">final_withdraw_mode</span>
            <span class="p">)</span>
            <span class="n">step2</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;pool&quot;</span><span class="p">:</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">pool2_address</span><span class="p">),</span>
                <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">step2_data</span><span class="p">,</span>
                <span class="s2">&quot;callback&quot;</span><span class="p">:</span> <span class="n">ZERO_ADDRESS</span><span class="p">,</span>
                <span class="s2">&quot;callbackData&quot;</span><span class="p">:</span> <span class="n">HexBytes</span><span class="p">(</span><span class="s2">&quot;0x&quot;</span><span class="p">),</span>
            <span class="p">}</span>

            <span class="n">path_obj</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;steps&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">step1</span><span class="p">,</span> <span class="n">step2</span><span class="p">],</span>
                <span class="s2">&quot;tokenIn&quot;</span><span class="p">:</span> <span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">token_in_start_address</span><span class="p">),</span>
                <span class="s2">&quot;amountIn&quot;</span><span class="p">:</span> <span class="n">amount_in_start</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path_obj</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">paths</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">paths</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Could not construct any swap path for </span><span class="si">{</span><span class="n">token_in_start_address</span><span class="si">}</span><span class="s2"> -&gt; &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token_out_final_address</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="n">InsufficientLiquidityError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No swap path found for </span><span class="si">{</span><span class="n">token_in_start_address</span><span class="si">}</span><span class="s2"> to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token_out_final_address</span><span class="si">}</span><span class="s2"> on SyncSwap.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">paths</span>


<div class="viewcode-block" id="swap_tokens">
<a class="viewcode-back" href="../../../../protocols.html#airdrops.protocols.scroll.scroll.swap_tokens">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">swap_tokens</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token_in_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token_out_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">amount_in</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">slippage_percent</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">deadline_seconds</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1800</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Swaps tokens on SyncSwap DEX on the Scroll network.</span>

<span class="sd">    Args:</span>
<span class="sd">        web3_scroll: Web3 instance for Scroll L2.</span>
<span class="sd">        private_key: Private key of the account performing the swap.</span>
<span class="sd">        token_in_symbol: Symbol of the token to swap from (e.g., &quot;ETH&quot;, &quot;USDC&quot;).</span>
<span class="sd">        token_out_symbol: Symbol of the token to swap to (e.g., &quot;USDC&quot;, &quot;WETH&quot;).</span>
<span class="sd">        amount_in: Amount of token_in to swap (in Wei or smallest unit).</span>
<span class="sd">        slippage_percent: Allowed slippage percentage (e.g., 0.5 for 0.5%).</span>
<span class="sd">        deadline_seconds: Transaction deadline in seconds from now.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Transaction hash of the swap operation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ScrollSwapError: For general swap-related errors.</span>
<span class="sd">        InsufficientLiquidityError: If liquidity is insufficient for the swap or</span>
<span class="sd">            no path found.</span>
<span class="sd">        TokenNotSupportedError: If one of the token symbols is not configured.</span>
<span class="sd">        ApprovalError: If token approval fails.</span>
<span class="sd">        TransactionRevertedError: If the swap transaction is reverted.</span>
<span class="sd">        GasEstimationError: If gas estimation fails.</span>
<span class="sd">        ValueError: For invalid inputs like slippage.</span>
<span class="sd">        ... (other relevant exceptions from airdrops.protocols.scroll.exceptions)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Initiating SyncSwap swap: </span><span class="si">{</span><span class="n">amount_in</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">token_in_symbol</span><span class="si">}</span><span class="s2"> -&gt; &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">token_out_symbol</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">slippage_percent</span><span class="si">}</span><span class="s2">% slippage, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;deadline </span><span class="si">{</span><span class="n">deadline_seconds</span><span class="si">}</span><span class="s2">s.&quot;</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">amount_in</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Amount to swap must be positive.&quot;</span><span class="p">)</span>

    <span class="n">account</span> <span class="o">=</span> <span class="n">_get_account_scroll</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">web3_scroll</span><span class="p">)</span>
    <span class="n">sender_address</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">address</span>
    <span class="n">recipient_address</span> <span class="o">=</span> <span class="n">sender_address</span>  <span class="c1"># Swaps benefit the sender</span>

    <span class="c1"># Resolve token addresses (ETH will be resolved to WETH for internal logic)</span>
    <span class="n">weth_l2_address</span> <span class="o">=</span> <span class="n">_get_l2_token_address_scroll</span><span class="p">(</span><span class="n">WETH_SYMBOL</span><span class="p">)</span>

    <span class="n">token_in_address_actual</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># The address used on-chain for token_in</span>
    <span class="n">is_eth_input</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">token_in_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
        <span class="n">token_in_address_actual</span> <span class="o">=</span> <span class="n">weth_l2_address</span>
        <span class="n">is_eth_input</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># Check ETH balance</span>
        <span class="n">eth_balance</span> <span class="o">=</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">sender_address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">eth_balance</span> <span class="o">&lt;</span> <span class="n">amount_in</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InsufficientBalanceError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Insufficient ETH balance for swap: have </span><span class="si">{</span><span class="n">eth_balance</span><span class="si">}</span><span class="s2">, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;need </span><span class="si">{</span><span class="n">amount_in</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token_in_address_actual</span> <span class="o">=</span> <span class="n">_get_l2_token_address_scroll</span><span class="p">(</span><span class="n">token_in_symbol</span><span class="p">)</span>
        <span class="c1"># Check ERC20 balance</span>
        <span class="n">token_in_contract</span> <span class="o">=</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">ERC20_ABI_NAME</span><span class="p">,</span> <span class="n">token_in_address_actual</span>
        <span class="p">)</span>
        <span class="n">erc20_balance</span> <span class="o">=</span> <span class="n">token_in_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">sender_address</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">erc20_balance</span> <span class="o">&lt;</span> <span class="n">amount_in</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InsufficientBalanceError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Insufficient </span><span class="si">{</span><span class="n">token_in_symbol</span><span class="si">}</span><span class="s2"> balance for swap: have &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">erc20_balance</span><span class="si">}</span><span class="s2">, need </span><span class="si">{</span><span class="n">amount_in</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="n">token_out_address_actual</span><span class="p">:</span> <span class="nb">str</span>
    <span class="k">if</span> <span class="n">token_out_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
        <span class="n">token_out_address_actual</span> <span class="o">=</span> <span class="n">weth_l2_address</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token_out_address_actual</span> <span class="o">=</span> <span class="n">_get_l2_token_address_scroll</span><span class="p">(</span><span class="n">token_out_symbol</span><span class="p">)</span>

    <span class="c1"># Deadline</span>
    <span class="n">current_block</span> <span class="o">=</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_block</span><span class="p">(</span><span class="s2">&quot;latest&quot;</span><span class="p">)</span>
    <span class="n">deadline</span> <span class="o">=</span> <span class="n">current_block</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">deadline_seconds</span>

    <span class="n">router_contract</span> <span class="o">=</span> <span class="n">_get_syncswap_router_contract_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">)</span>

    <span class="c1"># Get expected amount out and calculate min amount out</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">expected_amount_out</span> <span class="o">=</span> <span class="n">_get_expected_amount_out_syncswap_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span>
            <span class="n">token_in_address_actual</span><span class="p">,</span>
            <span class="n">token_out_address_actual</span><span class="p">,</span>
            <span class="n">amount_in</span><span class="p">,</span>
            <span class="n">sender_address</span><span class="p">,</span>
            <span class="n">weth_l2_address</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="n">InsufficientLiquidityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># Catch specific error from quoting</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Quoting failed due to insufficient liquidity or no path: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during expected amount out calculation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ScrollSwapError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not determine expected amount out: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">if</span> <span class="n">expected_amount_out</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">InsufficientLiquidityError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Expected output for </span><span class="si">{</span><span class="n">token_in_symbol</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">token_out_symbol</span><span class="si">}</span><span class="s2"> is 0. &quot;</span>
            <span class="s2">&quot;Check pool liquidity.&quot;</span>
        <span class="p">)</span>

    <span class="n">amount_out_min</span> <span class="o">=</span> <span class="n">_calculate_amount_out_min_syncswap_scroll</span><span class="p">(</span>
        <span class="n">expected_amount_out</span><span class="p">,</span> <span class="n">slippage_percent</span>
    <span class="p">)</span>

    <span class="c1"># Approve router if token_in is ERC20</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_eth_input</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Approving SyncSwap router </span><span class="si">{</span><span class="n">SYNC_SWAP_ROUTER_ADDRESS_SCROLL</span><span class="si">}</span><span class="s2"> to spend &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">amount_in</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">token_in_symbol</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">token_in_address_actual</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_approve_erc20_scroll</span><span class="p">(</span>
                <span class="n">web3_scroll</span><span class="p">,</span>
                <span class="n">private_key</span><span class="p">,</span>
                <span class="n">token_in_address_actual</span><span class="p">,</span>
                <span class="n">SYNC_SWAP_ROUTER_ADDRESS_SCROLL</span><span class="p">,</span>
                <span class="n">amount_in</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Approval successful for </span><span class="si">{</span><span class="n">token_in_symbol</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">ApprovalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERC20 approval for </span><span class="si">{</span><span class="n">token_in_symbol</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error during ERC20 approval for </span><span class="si">{</span><span class="n">token_in_symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">ApprovalError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unexpected error during ERC20 approval for </span><span class="si">{</span><span class="n">token_in_symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="c1"># Construct swap paths</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">swap_paths</span> <span class="o">=</span> <span class="n">_construct_syncswap_paths_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span>
            <span class="n">token_in_address_actual</span><span class="p">,</span>
            <span class="n">token_out_address_actual</span><span class="p">,</span>
            <span class="n">amount_in</span><span class="p">,</span>
            <span class="n">recipient_address</span><span class="p">,</span>
            <span class="n">weth_l2_address</span><span class="p">,</span>
            <span class="n">router_contract</span><span class="p">,</span>
            <span class="n">token_out_symbol</span><span class="p">,</span>  <span class="c1"># Pass the original token_out_symbol for</span>
            <span class="c1"># withdrawMode decision</span>
        <span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span>
        <span class="n">InsufficientLiquidityError</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path construction failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error constructing swap paths: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ScrollSwapError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not construct swap paths: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="c1"># Prepare transaction for router.swap()</span>
    <span class="c1"># paths: List[Tuple(List[Tuple(address, bytes, address, bytes)], address, int)]</span>
    <span class="c1"># Example from ABI: paths: IRouter.SwapPath[]</span>
    <span class="c1"># IRouter.SwapPath: { steps: IRouter.SwapStep[], tokenIn: address,</span>
    <span class="c1"># amountIn: uint256 }</span>
    <span class="c1"># IRouter.SwapStep: { pool: address, data: bytes, callback: address,</span>
    <span class="c1"># callbackData: bytes }</span>

    <span class="c1"># The _construct_syncswap_paths_scroll returns a list of dicts matching</span>
    <span class="c1"># the structure. Web3.py will convert these Python dicts/lists to tuples</span>
    <span class="c1"># as needed for the contract call.</span>

    <span class="n">tx_value</span> <span class="o">=</span> <span class="n">Wei</span><span class="p">(</span><span class="n">amount_in</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_eth_input</span> <span class="k">else</span> <span class="n">Wei</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">swap_tx_params_dict</span><span class="p">:</span> <span class="n">TxParams</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">sender_address</span><span class="p">,</span>
        <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">SYNC_SWAP_ROUTER_ADDRESS_SCROLL</span><span class="p">,</span>
        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">tx_value</span><span class="p">,</span>
        <span class="s2">&quot;gas&quot;</span><span class="p">:</span> <span class="n">Wei</span><span class="p">(</span>
            <span class="n">DEFAULT_SWAP_L2_GAS_LIMIT</span>
        <span class="p">),</span>  <span class="c1"># Provide a default, _build_and_send will estimate</span>
        <span class="c1"># nonce and gasPrice will be handled by _build_and_send_tx_scroll</span>
    <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Preparing swap transaction with router.swap(): paths=</span><span class="si">{</span><span class="n">swap_paths</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;amountOutMin=</span><span class="si">{</span><span class="n">amount_out_min</span><span class="si">}</span><span class="s2">, deadline=</span><span class="si">{</span><span class="n">deadline</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">swap_function</span><span class="p">:</span> <span class="n">ContractFunction</span> <span class="o">=</span> <span class="n">router_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span>
            <span class="n">swap_paths</span><span class="p">,</span> <span class="n">amount_out_min</span><span class="p">,</span> <span class="n">deadline</span>
        <span class="p">)</span>
        <span class="c1"># Build transaction without sending, _build_and_send_tx_scroll will</span>
        <span class="c1"># handle the rest</span>
        <span class="n">built_swap_tx</span> <span class="o">=</span> <span class="n">swap_function</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span><span class="n">swap_tx_params_dict</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Built swap transaction: </span><span class="si">{</span><span class="n">built_swap_tx</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">built_swap_tx</span><span class="p">)</span>

    <span class="k">except</span> <span class="p">(</span>
        <span class="n">ContractLogicError</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SyncSwap contract logic error: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2"> - Data: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;TooLittleReceived&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">e</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span> <span class="s2">&quot;0x087229a4&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">data</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">InsufficientLiquidityError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Swap likely to result in too little received (slippage or &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;liquidity): </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">tx_data</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;Expired&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">e</span><span class="o">.</span><span class="n">data</span> <span class="ow">and</span> <span class="s2">&quot;0x414432ea&quot;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">data</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">ScrollSwapError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Swap transaction expired: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">tx_data</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">data</span>
            <span class="p">)</span>
        <span class="k">raise</span> <span class="n">TransactionRevertedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SyncSwap swap reverted with logic error: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">receipt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">tx_hash</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">except</span> <span class="n">GasEstimationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Gas estimation failed for swap transaction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unexpected error preparing or sending swap transaction: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ScrollSwapError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to execute swap: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span></div>



<span class="c1"># --- LayerBank Lending Helper Functions ---</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_layerbank_lbtoken_address_scroll</span><span class="p">(</span><span class="n">token_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get LayerBank lbToken address for a given token symbol.</span>

<span class="sd">    Args:</span>
<span class="sd">        token_symbol: Token symbol (&quot;ETH&quot; or &quot;USDC&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        lbToken contract address.</span>

<span class="sd">    Raises:</span>
<span class="sd">        TokenNotSupportedError: If token symbol is not supported.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; address = _get_layerbank_lbtoken_address_scroll(&quot;ETH&quot;)</span>
<span class="sd">        &gt;&gt;&gt; print(address)</span>
<span class="sd">        0x7E08A050000201d938279b3A0e293A49A729505E</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">token_symbol</span> <span class="o">==</span> <span class="s2">&quot;ETH&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LAYERBANK_LBETH_ADDRESS_SCROLL</span>
    <span class="k">elif</span> <span class="n">token_symbol</span> <span class="o">==</span> <span class="s2">&quot;USDC&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LAYERBANK_LBUSDC_ADDRESS_SCROLL</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TokenNotSupportedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Token symbol &#39;</span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2">&#39; not supported for LayerBank lending. &quot;</span>
            <span class="s2">&quot;Supported tokens: ETH, USDC&quot;</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_check_and_enter_layerbank_market_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">lbtoken_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if user has entered the LayerBank market and enter if not.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># DEBUG: _check_and_enter_layerbank_market_scroll - lbtoken_address</span>
    <span class="n">comptroller_contract</span> <span class="o">=</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
        <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">LAYERBANK_COMPTROLLER_ABI_NAME</span><span class="p">,</span>
        <span class="n">LAYERBANK_COMPTROLLER_ADDRESS_SCROLL</span>
    <span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if user has already entered this market</span>
        <span class="n">is_member</span> <span class="o">=</span> <span class="n">comptroller_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">checkMembership</span><span class="p">(</span>
            <span class="n">user_address</span><span class="p">,</span> <span class="n">lbtoken_address</span>
        <span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_member</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Entering LayerBank market for lbToken </span><span class="si">{</span><span class="n">lbtoken_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tx_params</span><span class="p">:</span> <span class="n">TxParams</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">user_address</span><span class="p">,</span>
                <span class="s2">&quot;gasPrice&quot;</span><span class="p">:</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">enter_markets_tx</span> <span class="o">=</span> <span class="n">comptroller_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">enterMarkets</span><span class="p">(</span>
                <span class="p">[</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">lbtoken_address</span><span class="p">)]</span>
            <span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span><span class="n">tx_params</span><span class="p">)</span>

            <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">enter_markets_tx</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Successfully entered LayerBank market for </span><span class="si">{</span><span class="n">lbtoken_address</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Already a member of LayerBank market </span><span class="si">{</span><span class="n">lbtoken_address</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to enter LayerBank market </span><span class="si">{</span><span class="n">lbtoken_address</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ScrollLendingError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to enter LayerBank market: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
    <span class="k">return</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_layerbank_account_liquidity_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">comptroller_contract</span><span class="p">:</span> <span class="n">Contract</span><span class="p">,</span>
    <span class="n">user_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get account liquidity information from LayerBank Comptroller.</span>

<span class="sd">    Args:</span>
<span class="sd">        web3_scroll: Web3 instance for Scroll L2.</span>
<span class="sd">        comptroller_contract: LayerBank Comptroller contract instance.</span>
<span class="sd">        user_address: User&#39;s wallet address.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple of (error_code, liquidity_usd, shortfall_usd).</span>

<span class="sd">    Raises:</span>
<span class="sd">        ScrollLendingError: If liquidity check fails.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; error, liquidity, shortfall = \</span>
<span class="sd">        _get_layerbank_account_liquidity_scroll(</span>
<span class="sd">        ...     web3_scroll, comptroller_contract, user_address</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Liquidity: {liquidity}, Shortfall: {shortfall}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">comptroller_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">getAccountLiquidity</span><span class="p">(</span>
            <span class="n">user_address</span>
        <span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
        <span class="n">error_code</span><span class="p">,</span> <span class="n">liquidity_usd</span><span class="p">,</span> <span class="n">shortfall_usd</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">error_code</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">liquidity_usd</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">shortfall_usd</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get account liquidity for </span><span class="si">{</span><span class="n">user_address</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ScrollLendingError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get account liquidity: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>


    <span class="k">return</span>


    <span class="k">return</span>


    <span class="k">return</span>


    <span class="k">return</span>


    <span class="k">return</span>


    <span class="k">return</span>


    <span class="k">return</span>


<div class="viewcode-block" id="lend_borrow_layerbank_scroll">
<a class="viewcode-back" href="../../../../protocols.html#airdrops.protocols.scroll.scroll.lend_borrow_layerbank_scroll">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">lend_borrow_layerbank_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles lending, borrowing, repaying, and withdrawing assets on LayerBank V2 on</span>
<span class="sd">    Scroll.</span>

<span class="sd">    Args:</span>
<span class="sd">        web3_scroll: Web3 instance for Scroll L2.</span>
<span class="sd">        private_key: Private key of the account.</span>
<span class="sd">        action: Action to perform (&quot;lend&quot;, &quot;borrow&quot;, &quot;repay&quot;, &quot;withdraw&quot;).</span>
<span class="sd">        token_symbol: Token symbol (&quot;ETH&quot; or &quot;USDC&quot;).</span>
<span class="sd">        amount: Amount in Wei for ETH, smallest unit for USDC.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Transaction hash of the operation.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ScrollLendingError: For general lending-related errors.</span>
<span class="sd">        InsufficientCollateralError: When insufficient collateral for borrowing.</span>
<span class="sd">        TokenNotSupportedError: If token symbol is not supported.</span>
<span class="sd">        InsufficientBalanceError: If account balance is insufficient.</span>
<span class="sd">        ApprovalError: If token approval fails.</span>
<span class="sd">        TransactionRevertedError: If transaction is reverted.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; tx_hash = lend_borrow_layerbank_scroll(</span>
<span class="sd">        ...     web3_scroll, private_key, &quot;lend&quot;, &quot;ETH&quot;, 1000000000000000000</span>
<span class="sd">        ... )</span>
<span class="sd">        &gt;&gt;&gt; print(f&quot;Transaction hash: {tx_hash}&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initiating LayerBank </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Validate inputs</span>
    <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;lend&quot;</span><span class="p">,</span> <span class="s2">&quot;borrow&quot;</span><span class="p">,</span> <span class="s2">&quot;repay&quot;</span><span class="p">,</span> <span class="s2">&quot;withdraw&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid action: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">. Must be one of: lend, borrow, repay, &quot;</span>
            <span class="s2">&quot;withdraw&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">token_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;ETH&quot;</span><span class="p">,</span> <span class="s2">&quot;USDC&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">TokenNotSupportedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Token </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> not supported for LayerBank&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">amount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Amount must be positive&quot;</span><span class="p">)</span>

    <span class="n">account</span> <span class="o">=</span> <span class="n">_get_account_scroll</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">web3_scroll</span><span class="p">)</span>
    <span class="n">user_address</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">address</span>

    <span class="c1"># Get lbToken address</span>
    <span class="n">lbtoken_address</span> <span class="o">=</span> <span class="n">_get_layerbank_lbtoken_address_scroll</span><span class="p">(</span><span class="n">token_symbol</span><span class="p">)</span>
    <span class="n">lbtoken_contract</span> <span class="o">=</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
        <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">LAYERBANK_LBTOKEN_ABI_NAME</span><span class="p">,</span> <span class="n">lbtoken_address</span>
    <span class="p">)</span>

    <span class="c1"># Get comptroller contract for market operations</span>
    <span class="n">comptroller_contract</span> <span class="o">=</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
        <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">LAYERBANK_COMPTROLLER_ABI_NAME</span><span class="p">,</span>
        <span class="n">LAYERBANK_COMPTROLLER_ADDRESS_SCROLL</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;lend&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_handle_lend_action_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">token_symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">user_address</span><span class="p">,</span>
            <span class="n">lbtoken_contract</span><span class="p">,</span> <span class="n">lbtoken_address</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;withdraw&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_handle_withdraw_action_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">token_symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">user_address</span><span class="p">,</span>
            <span class="n">lbtoken_contract</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;borrow&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_handle_borrow_action_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">token_symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">user_address</span><span class="p">,</span>
            <span class="n">lbtoken_contract</span><span class="p">,</span> <span class="n">comptroller_contract</span><span class="p">,</span> <span class="n">lbtoken_address</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;repay&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_handle_repay_action_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">token_symbol</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">user_address</span><span class="p">,</span>
            <span class="n">lbtoken_contract</span>
        <span class="p">)</span>
    
    <span class="c1"># This should never be reached due to validation above, but mypy requires it</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;</span></div>



<span class="k">def</span><span class="w"> </span><span class="nf">_handle_lend_action_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">user_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">lbtoken_contract</span><span class="p">:</span> <span class="n">Contract</span><span class="p">,</span>
    <span class="n">lbtoken_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle lending (supply) action for LayerBank.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lending </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> to LayerBank&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token_symbol</span> <span class="o">==</span> <span class="s2">&quot;ETH&quot;</span><span class="p">:</span>
            <span class="c1"># Check ETH balance</span>
            <span class="n">eth_balance</span> <span class="o">=</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">user_address</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">eth_balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InsufficientBalanceError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Insufficient ETH balance: have </span><span class="si">{</span><span class="n">eth_balance</span><span class="si">}</span><span class="s2">, need </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Call mint() with ETH value</span>
            <span class="n">tx_params</span><span class="p">:</span> <span class="n">TxParams</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">user_address</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">Wei</span><span class="p">(</span><span class="n">amount</span><span class="p">),</span>
                <span class="s2">&quot;gasPrice&quot;</span><span class="p">:</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">mint_tx</span> <span class="o">=</span> <span class="n">lbtoken_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">mint</span><span class="p">()</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span><span class="n">tx_params</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># USDC</span>
            <span class="c1"># Check USDC balance and approve</span>
            <span class="n">usdc_contract</span> <span class="o">=</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
                <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">ERC20_ABI_NAME</span><span class="p">,</span> <span class="n">SCROLL_USDC_TOKEN_ADDRESS</span>
            <span class="p">)</span>
            <span class="n">usdc_balance</span> <span class="o">=</span> <span class="n">usdc_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">user_address</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">usdc_balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InsufficientBalanceError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Insufficient USDC balance: have </span><span class="si">{</span><span class="n">usdc_balance</span><span class="si">}</span><span class="s2">, need </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Approve lbToken contract to spend USDC</span>
            <span class="n">_approve_erc20_scroll</span><span class="p">(</span>
                <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">SCROLL_USDC_TOKEN_ADDRESS</span><span class="p">,</span>
                <span class="n">lbtoken_address</span><span class="p">,</span> <span class="n">amount</span>
            <span class="p">)</span>

            <span class="c1"># Call mint(amount)</span>
            <span class="n">tx_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">user_address</span><span class="p">,</span>
                <span class="s2">&quot;gasPrice&quot;</span><span class="p">:</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">mint_tx</span> <span class="o">=</span> <span class="n">lbtoken_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">mint</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span>
                <span class="n">tx_params</span>
            <span class="p">)</span>

        <span class="c1"># Send mint transaction</span>
        <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">mint_tx</span><span class="p">)</span>

        <span class="c1"># Enter market after successful lend</span>
        <span class="n">_check_and_enter_layerbank_market_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">lbtoken_address</span><span class="p">,</span> <span class="n">user_address</span>
        <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully lent </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> to LayerBank&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tx_hash</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lending failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">InsufficientBalanceError</span><span class="p">,</span> <span class="n">ApprovalError</span><span class="p">)):</span>
            <span class="k">raise</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">TransactionRevertedError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ScrollLendingError</span><span class="p">(</span><span class="s2">&quot;Lending failed&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
        <span class="k">raise</span> <span class="n">ScrollLendingError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lending failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_handle_withdraw_action_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">user_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">lbtoken_contract</span><span class="p">:</span> <span class="n">Contract</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle withdraw (redeem) action for LayerBank.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Withdrawing </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> from LayerBank&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Call redeemUnderlying(amount)</span>
        <span class="n">tx_params</span><span class="p">:</span> <span class="n">TxParams</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">user_address</span><span class="p">,</span>
            <span class="s2">&quot;gasPrice&quot;</span><span class="p">:</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">redeem_tx</span> <span class="o">=</span> <span class="n">lbtoken_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">redeemUnderlying</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span>
            <span class="n">tx_params</span>
        <span class="p">)</span>

        <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">redeem_tx</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully withdrew </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> from LayerBank&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tx_hash</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Withdrawal failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">TransactionRevertedError</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="k">raise</span> <span class="n">ScrollLendingError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Withdrawal failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_handle_borrow_action_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">user_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">lbtoken_contract</span><span class="p">:</span> <span class="n">Contract</span><span class="p">,</span>
    <span class="n">comptroller_contract</span><span class="p">:</span> <span class="n">Contract</span><span class="p">,</span>
    <span class="n">lbtoken_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># Add lbtoken_address here</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle borrow action for LayerBank.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Borrowing </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> from LayerBank&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Enter market if not already entered (for borrow operations)</span>
        <span class="n">_check_and_enter_layerbank_market_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">lbtoken_contract</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">user_address</span>
        <span class="p">)</span>

        <span class="c1"># Check account liquidity before borrowing</span>
        <span class="n">error_code</span><span class="p">,</span> <span class="n">liquidity_usd</span><span class="p">,</span> <span class="n">shortfall_usd</span> <span class="o">=</span> <span class="n">_get_layerbank_account_liquidity_scroll</span><span class="p">(</span>
            <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">comptroller_contract</span><span class="p">,</span> <span class="n">user_address</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">error_code</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">LayerBankComptrollerRejectionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Comptroller error when checking liquidity: </span><span class="si">{</span><span class="n">error_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">error_code</span><span class="o">=</span><span class="n">error_code</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">shortfall_usd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InsufficientCollateralError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Account has shortfall: </span><span class="si">{</span><span class="n">shortfall_usd</span><span class="si">}</span><span class="s2">. Cannot borrow.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">liquidity_usd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">InsufficientCollateralError</span><span class="p">(</span>
                <span class="s2">&quot;No available liquidity for borrowing. Please supply collateral first.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Call borrow(amount)</span>
        <span class="n">tx_params</span><span class="p">:</span> <span class="n">TxParams</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">user_address</span><span class="p">,</span>
            <span class="s2">&quot;gasPrice&quot;</span><span class="p">:</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">borrow_tx</span> <span class="o">=</span> <span class="n">lbtoken_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">borrow</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span><span class="n">tx_params</span><span class="p">)</span>

        <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">borrow_tx</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully borrowed </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> from LayerBank&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tx_hash</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Borrowing failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">InsufficientCollateralError</span><span class="p">,</span> <span class="n">LayerBankComptrollerRejectionError</span><span class="p">,</span> <span class="n">TransactionRevertedError</span><span class="p">)):</span>
            <span class="k">raise</span>
        <span class="k">raise</span> <span class="n">ScrollLendingError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Borrowing failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_handle_repay_action_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">user_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">lbtoken_contract</span><span class="p">:</span> <span class="n">Contract</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle repay action for LayerBank.&quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Repaying </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> to LayerBank&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Check if repay amount exceeds current debt (unless it&#39;s max uint256 for full repayment)</span>
        <span class="n">MAX_UINT256</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">256</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">amount</span> <span class="o">!=</span> <span class="n">MAX_UINT256</span><span class="p">:</span>
            <span class="n">current_debt</span> <span class="o">=</span> <span class="n">lbtoken_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">borrowBalanceStored</span><span class="p">(</span><span class="n">user_address</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">amount</span> <span class="o">&gt;</span> <span class="n">current_debt</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">RepayAmountExceedsDebtError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Repay amount </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> exceeds current debt </span><span class="si">{</span><span class="n">current_debt</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current debt: </span><span class="si">{</span><span class="n">current_debt</span><span class="si">}</span><span class="s2">, repaying: </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">token_symbol</span> <span class="o">==</span> <span class="s2">&quot;ETH&quot;</span><span class="p">:</span>
            <span class="c1"># Check ETH balance</span>
            <span class="n">eth_balance</span> <span class="o">=</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">user_address</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">eth_balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InsufficientBalanceError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Insufficient ETH balance for repayment: have </span><span class="si">{</span><span class="n">eth_balance</span><span class="si">}</span><span class="s2">, need </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Call repayBorrow() with ETH value</span>
            <span class="n">tx_params</span><span class="p">:</span> <span class="n">TxParams</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">user_address</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">Wei</span><span class="p">(</span><span class="n">amount</span><span class="p">),</span>
                <span class="s2">&quot;gasPrice&quot;</span><span class="p">:</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">repay_tx</span> <span class="o">=</span> <span class="n">lbtoken_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">repayBorrow</span><span class="p">()</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span>
                <span class="n">tx_params</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># USDC</span>
            <span class="c1"># Check USDC balance and approve</span>
            <span class="n">usdc_contract</span> <span class="o">=</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
                <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">ERC20_ABI_NAME</span><span class="p">,</span> <span class="n">SCROLL_USDC_TOKEN_ADDRESS</span>
            <span class="p">)</span>
            <span class="n">usdc_balance</span> <span class="o">=</span> <span class="n">usdc_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">user_address</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">usdc_balance</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InsufficientBalanceError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Insufficient USDC balance for repayment: have </span><span class="si">{</span><span class="n">usdc_balance</span><span class="si">}</span><span class="s2">, need </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Approve lbToken contract to spend USDC</span>
            <span class="n">lbtoken_address</span> <span class="o">=</span> <span class="n">_get_layerbank_lbtoken_address_scroll</span><span class="p">(</span><span class="n">token_symbol</span><span class="p">)</span>
            <span class="n">_approve_erc20_scroll</span><span class="p">(</span>
                <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">SCROLL_USDC_TOKEN_ADDRESS</span><span class="p">,</span>
                <span class="n">lbtoken_address</span><span class="p">,</span> <span class="n">amount</span>
            <span class="p">)</span>

            <span class="c1"># Call repayBorrow(amount)</span>
            <span class="n">tx_params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">user_address</span><span class="p">,</span>
                <span class="s2">&quot;gasPrice&quot;</span><span class="p">:</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">gas_price</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">repay_tx</span> <span class="o">=</span> <span class="n">lbtoken_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">repayBorrow</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span><span class="n">tx_params</span><span class="p">)</span>

        <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">repay_tx</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully repaid </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> to LayerBank&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tx_hash</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Repayment failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="p">(</span><span class="n">InsufficientBalanceError</span><span class="p">,</span> <span class="n">ApprovalError</span><span class="p">,</span> <span class="n">TransactionRevertedError</span><span class="p">,</span> <span class="n">RepayAmountExceedsDebtError</span><span class="p">)):</span>
            <span class="k">raise</span>
        <span class="k">raise</span> <span class="n">ScrollLendingError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Repayment failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>


<span class="c1"># --- Bridge Assets (existing function, ensure it&#39;s compatible) ---</span>
<div class="viewcode-block" id="bridge_assets">
<a class="viewcode-back" href="../../../../protocols.html#airdrops.protocols.scroll.scroll.bridge_assets">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">bridge_assets</span><span class="p">(</span>
    <span class="n">web3_l1</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">web3_l2</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># &quot;deposit&quot; or &quot;withdraw&quot;</span>
    <span class="n">token_symbol</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>  <span class="c1"># &quot;ETH&quot;, &quot;WETH&quot;, &quot;USDC&quot;, &quot;USDT&quot;</span>
    <span class="n">amount</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">recipient_address</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bridges assets (ETH or ERC20 tokens) between Ethereum (L1) and Scroll (L2).</span>
<span class="sd">    (Existing function - minor adjustments for consistency if needed, but largely untouched for this task)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Initiating bridge_assets: direction=&#39;</span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">&#39;, token=&#39;</span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;amount=</span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">, recipient=&#39;</span><span class="si">{</span><span class="n">recipient_address</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;deposit&quot;</span><span class="p">,</span> <span class="s2">&quot;withdraw&quot;</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid direction provided: </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid direction: </span><span class="si">{</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Use shared_config for token addresses consistently</span>
    <span class="k">if</span> <span class="n">token_symbol</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">shared_config</span><span class="o">.</span><span class="n">SCROLL_TOKEN_ADDRESSES</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TokenNotSupportedError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Token </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> not in shared_config.SCROLL_TOKEN_ADDRESSES&quot;</span>
        <span class="p">)</span>

    <span class="n">token_config_shared</span> <span class="o">=</span> <span class="n">shared_config</span><span class="o">.</span><span class="n">SCROLL_TOKEN_ADDRESSES</span><span class="p">[</span><span class="n">token_symbol</span><span class="p">]</span>

    <span class="n">account</span> <span class="o">=</span> <span class="n">_get_account_scroll</span><span class="p">(</span>
        <span class="n">private_key</span><span class="p">,</span> <span class="n">web3_l1</span> <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;deposit&quot;</span> <span class="k">else</span> <span class="n">web3_l2</span>
    <span class="p">)</span>
    <span class="n">sender</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">address</span>
    <span class="n">to_addr</span> <span class="o">=</span> <span class="n">recipient_address</span> <span class="ow">or</span> <span class="n">sender</span>

    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;deposit&quot;</span><span class="p">:</span>
        <span class="n">l1_rpc_url_from_config</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">shared_config</span><span class="p">,</span> <span class="s2">&quot;SCROLL_L1_RPC_URL&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">web3_l1</span><span class="o">.</span><span class="n">provider</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">web3_l1</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span> <span class="s2">&quot;endpoint_uri&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="n">l1_rpc_url_from_config</span>
                <span class="ow">and</span> <span class="n">web3_l1</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">endpoint_uri</span> <span class="o">!=</span> <span class="n">l1_rpc_url_from_config</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;web3_l1 provider endpoint might not match SCROLL_L1_RPC_URL in config.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">token_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
            <span class="n">l1_router</span> <span class="o">=</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
                <span class="n">web3_l1</span><span class="p">,</span> <span class="n">L1_GATEWAY_ROUTER_ABI_NAME</span><span class="p">,</span>
                <span class="n">SCROLL_L1_GATEWAY_ROUTER_ADDRESS</span>
            <span class="p">)</span>
            <span class="n">l2_gas_limit</span> <span class="o">=</span> <span class="n">DEFAULT_L2_GAS_LIMIT</span>
            <span class="c1"># l2_gas_price = web3_l2.eth.gas_price # Not directly used by estimateCrossDomainMessageFee</span>
            <span class="n">fee</span> <span class="o">=</span> <span class="n">_estimate_l1_to_l2_message_fee_scroll</span><span class="p">(</span>
                <span class="n">web3_l1</span><span class="p">,</span>
                <span class="n">l2_gas_limit</span><span class="p">,</span>  <span class="c1"># , l2_gas_price # Pass if needed by future oracle versions</span>
            <span class="p">)</span>
            <span class="n">total_value</span> <span class="o">=</span> <span class="n">amount</span> <span class="o">+</span> <span class="n">fee</span>
            <span class="k">if</span> <span class="n">web3_l1</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">total_value</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InsufficientBalanceError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Insufficient ETH for deposit (</span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">) + fee (</span><span class="si">{</span><span class="n">fee</span><span class="si">}</span><span class="s2">) = </span><span class="si">{</span><span class="n">total_value</span><span class="si">}</span><span class="s2">. Balance: </span><span class="si">{</span><span class="n">web3_l1</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">tx_build_params</span><span class="p">:</span> <span class="n">TxParams</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">sender</span><span class="p">,</span>
                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">SCROLL_L1_GATEWAY_ROUTER_ADDRESS</span><span class="p">,</span>  <span class="c1"># Added &#39;to&#39;</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">Wei</span><span class="p">(</span><span class="n">total_value</span><span class="p">),</span>
                <span class="c1"># gasPrice, nonce, gas handled by _build_and_send_tx_scroll</span>
            <span class="p">}</span>
            <span class="c1"># depositETH(address _to, uint256 _amount, uint256 _gasLimit, uint256 _fee)</span>
            <span class="n">deposit_eth_fn</span> <span class="o">=</span> <span class="n">l1_router</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">depositETH</span><span class="p">(</span>
                <span class="n">to_addr</span><span class="p">,</span>
                <span class="n">amount</span><span class="p">,</span>
                <span class="n">l2_gas_limit</span><span class="p">,</span>  <span class="c1"># , fee # fee is part of msg.value, not a function arg here</span>
            <span class="p">)</span>
            <span class="c1"># The `fee` for `depositETH` is actually `msg.value - amount`. The contract calculates it.</span>
            <span class="c1"># The `_fee` parameter in `depositETH` was removed in some versions.</span>
            <span class="c1"># The L1GatewayRouter ABI used (from file) for depositETH:</span>
            <span class="c1"># &quot;name&quot;: &quot;depositETH&quot;, &quot;outputs&quot;: [], &quot;stateMutability&quot;: &quot;payable&quot;, &quot;type&quot;: &quot;function&quot;,</span>
            <span class="c1"># &quot;inputs&quot;: [{&quot;internalType&quot;: &quot;address&quot;, &quot;name&quot;: &quot;_to&quot;, &quot;type&quot;: &quot;address&quot;},</span>
            <span class="c1">#            {&quot;internalType&quot;: &quot;uint256&quot;, &quot;name&quot;: &quot;_amount&quot;, &quot;type&quot;: &quot;uint256&quot;},</span>
            <span class="c1">#            {&quot;internalType&quot;: &quot;uint256&quot;, &quot;name&quot;: &quot;_gasLimit&quot;, &quot;type&quot;: &quot;uint256&quot;}]</span>
            <span class="c1"># So, the `fee` is not passed as a function argument but is part of msg.value.</span>
            <span class="c1"># The `_estimate_l1_to_l2_message_fee_scroll` is correct for calculating the `value`.</span>
            <span class="c1"># The function signature in the ABI provided in scroll.py for L1GatewayRouter.json should be checked.</span>
            <span class="c1"># Assuming the ABI in scroll.py is for a version that doesn&#39;t take `_fee` as param.</span>
            <span class="c1"># If it does, the call should be: l1_router.functions.depositETH(to_addr, amount, l2_gas_limit, fee)</span>
            <span class="c1"># Let&#39;s assume the ABI in `L1GatewayRouter.json` is the source of truth.</span>
            <span class="c1"># Reading L1GatewayRouter.json ABI:</span>
            <span class="c1"># { &quot;inputs&quot;: [ { &quot;internalType&quot;: &quot;address&quot;, &quot;name&quot;: &quot;to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;internalType&quot;: &quot;uint256&quot;, &quot;name&quot;: &quot;amount&quot;, &quot;type&quot;: &quot;uint256&quot; }, { &quot;internalType&quot;: &quot;uint256&quot;, &quot;name&quot;: &quot;gasLimit&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;depositETH&quot;, &quot;outputs&quot;: [], &quot;stateMutability&quot;: &quot;payable&quot;, &quot;type&quot;: &quot;function&quot; }</span>
            <span class="c1"># Correct, no `_fee` argument.</span>

            <span class="n">tx</span> <span class="o">=</span> <span class="n">deposit_eth_fn</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span><span class="n">tx_build_params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span><span class="n">web3_l1</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># ERC20 Deposit</span>
            <span class="n">l1_token_addr</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">token_config_shared</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;L1&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">l1_token_addr</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TokenNotSupportedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;L1 address for </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> not configured.&quot;</span>
                <span class="p">)</span>

            <span class="n">l1_router_addr</span> <span class="o">=</span> <span class="n">SCROLL_L1_GATEWAY_ROUTER_ADDRESS</span>
            <span class="n">_approve_erc20_scroll</span><span class="p">(</span>  <span class="c1"># This uses web3_l1 internally for approval</span>
                <span class="n">web3_l1</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">l1_token_addr</span><span class="p">,</span> <span class="n">l1_router_addr</span><span class="p">,</span> <span class="n">amount</span>
            <span class="p">)</span>
            <span class="n">l1_router</span> <span class="o">=</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
                <span class="n">web3_l1</span><span class="p">,</span> <span class="n">L1_GATEWAY_ROUTER_ABI_NAME</span><span class="p">,</span> <span class="n">l1_router_addr</span>
            <span class="p">)</span>
            <span class="n">l2_gas_limit</span> <span class="o">=</span> <span class="n">DEFAULT_L2_GAS_LIMIT</span>
            <span class="c1"># l2_gas_price = web3_l2.eth.gas_price</span>
            <span class="n">fee</span> <span class="o">=</span> <span class="n">_estimate_l1_to_l2_message_fee_scroll</span><span class="p">(</span>
                <span class="n">web3_l1</span><span class="p">,</span> <span class="n">l2_gas_limit</span>  <span class="c1"># , l2_gas_price</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">web3_l1</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">fee</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InsufficientBalanceError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Insufficient ETH for L2 execution fee (</span><span class="si">{</span><span class="n">fee</span><span class="si">}</span><span class="s2">). Balance: </span><span class="si">{</span><span class="n">web3_l1</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">tx_build_erc20_params</span><span class="p">:</span> <span class="n">TxParams</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">sender</span><span class="p">,</span>
                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">l1_router_addr</span><span class="p">,</span>  <span class="c1"># Added &#39;to&#39;</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">Wei</span><span class="p">(</span><span class="n">fee</span><span class="p">),</span>
                <span class="c1"># gasPrice, nonce, gas handled by _build_and_send_tx_scroll</span>
            <span class="p">}</span>
            <span class="c1"># depositERC20(address _token, address _to, uint256 _amount, uint256 _gasLimit, uint256 _fee)</span>
            <span class="c1"># ABI check for L1GatewayRouter.json depositERC20:</span>
            <span class="c1"># { &quot;inputs&quot;: [ { &quot;internalType&quot;: &quot;address&quot;, &quot;name&quot;: &quot;token&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;internalType&quot;: &quot;address&quot;, &quot;name&quot;: &quot;to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;internalType&quot;: &quot;uint256&quot;, &quot;name&quot;: &quot;amount&quot;, &quot;type&quot;: &quot;uint256&quot; }, { &quot;internalType&quot;: &quot;uint256&quot;, &quot;name&quot;: &quot;gasLimit&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;depositERC20&quot;, &quot;outputs&quot;: [], &quot;stateMutability&quot;: &quot;payable&quot;, &quot;type&quot;: &quot;function&quot; }</span>
            <span class="c1"># Correct, no `_fee` argument.</span>
            <span class="n">deposit_erc20_fn</span> <span class="o">=</span> <span class="n">l1_router</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">depositERC20</span><span class="p">(</span>
                <span class="n">l1_token_addr</span><span class="p">,</span> <span class="n">to_addr</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">l2_gas_limit</span>  <span class="c1"># , fee</span>
            <span class="p">)</span>
            <span class="n">tx</span> <span class="o">=</span> <span class="n">deposit_erc20_fn</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span><span class="n">tx_build_erc20_params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span><span class="n">web3_l1</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Withdraw (L2 to L1)</span>
        <span class="n">l2_rpc_url_from_config</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">shared_config</span><span class="p">,</span> <span class="s2">&quot;SCROLL_L2_RPC_URL&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="ow">not</span> <span class="n">web3_l2</span><span class="o">.</span><span class="n">provider</span>
            <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">web3_l2</span><span class="o">.</span><span class="n">provider</span><span class="p">,</span> <span class="s2">&quot;endpoint_uri&quot;</span><span class="p">)</span>
            <span class="ow">or</span> <span class="p">(</span>
                <span class="n">l2_rpc_url_from_config</span>
                <span class="ow">and</span> <span class="n">web3_l2</span><span class="o">.</span><span class="n">provider</span><span class="o">.</span><span class="n">endpoint_uri</span> <span class="o">!=</span> <span class="n">l2_rpc_url_from_config</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;web3_l2 provider endpoint might not match SCROLL_L2_RPC_URL in config.&quot;</span>
            <span class="p">)</span>

        <span class="n">l2_router</span> <span class="o">=</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
            <span class="n">web3_l2</span><span class="p">,</span> <span class="n">L2_GATEWAY_ROUTER_ABI_NAME</span><span class="p">,</span> <span class="n">SCROLL_L2_GATEWAY_ROUTER_ADDRESS</span>
        <span class="p">)</span>
        <span class="c1"># l2_gas_limit = DEFAULT_L2_GAS_LIMIT # This is for L1 execution of L2-&gt;L1 message, not L2 tx gas.</span>
        <span class="c1"># The L2 transaction gas limit is estimated by _build_and_send_tx_scroll.</span>
        <span class="c1"># The `_gasLimit` parameter in withdraw functions is for the L1 execution part.</span>
        <span class="n">l1_execution_gas_limit</span> <span class="o">=</span> <span class="n">DEFAULT_L2_GAS_LIMIT</span>  <span class="c1"># Renamed for clarity</span>

        <span class="k">if</span> <span class="n">token_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">web3_l2</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InsufficientBalanceError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Insufficient ETH for withdrawal (</span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">). Balance: </span><span class="si">{</span><span class="n">web3_l2</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">tx_build_withdraw_eth_params</span><span class="p">:</span> <span class="n">TxParams</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">sender</span><span class="p">,</span>
                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">SCROLL_L2_GATEWAY_ROUTER_ADDRESS</span><span class="p">,</span>  <span class="c1"># Added &#39;to&#39;</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">Wei</span><span class="p">(</span><span class="n">amount</span><span class="p">),</span>  <span class="c1"># msg.value is the amount of ETH to withdraw</span>
                <span class="c1"># gasPrice, nonce, gas handled by _build_and_send_tx_scroll</span>
            <span class="p">}</span>
            <span class="c1"># withdrawETH(address _to, uint256 _amount, uint256 _gasLimit)</span>
            <span class="c1"># ABI check for L2GatewayRouter.json withdrawETH:</span>
            <span class="c1"># { &quot;inputs&quot;: [ { &quot;internalType&quot;: &quot;address&quot;, &quot;name&quot;: &quot;to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;internalType&quot;: &quot;uint256&quot;, &quot;name&quot;: &quot;amount&quot;, &quot;type&quot;: &quot;uint256&quot; }, { &quot;internalType&quot;: &quot;uint256&quot;, &quot;name&quot;: &quot;gasLimit&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;withdrawETH&quot;, &quot;outputs&quot;: [], &quot;stateMutability&quot;: &quot;payable&quot;, &quot;type&quot;: &quot;function&quot; }</span>
            <span class="c1"># Correct.</span>
            <span class="n">withdraw_eth_fn</span> <span class="o">=</span> <span class="n">l2_router</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">withdrawETH</span><span class="p">(</span>
                <span class="n">to_addr</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">l1_execution_gas_limit</span>
            <span class="p">)</span>
            <span class="n">tx</span> <span class="o">=</span> <span class="n">withdraw_eth_fn</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span><span class="n">tx_build_withdraw_eth_params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span><span class="n">web3_l2</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># ERC20 Withdraw</span>
            <span class="n">token_config_entry_l2</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">token_config_shared</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;L2&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">token_config_entry_l2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">TokenNotSupportedError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;L2 address for </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> not configured.&quot;</span>
                <span class="p">)</span>
            <span class="n">l2_token_addr</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">token_config_entry_l2</span><span class="p">)</span>

            <span class="c1"># For ERC20 withdrawal, approval is needed on L2 for the L2GatewayRouter to pull tokens.</span>
            <span class="c1"># This was missing in the original logic.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Approving L2 Gateway Router </span><span class="si">{</span><span class="n">SCROLL_L2_GATEWAY_ROUTER_ADDRESS</span><span class="si">}</span><span class="s2"> to spend </span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2"> of </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">l2_token_addr</span><span class="si">}</span><span class="s2">) on L2.&quot;</span>
            <span class="p">)</span>
            <span class="n">_approve_erc20_scroll</span><span class="p">(</span>
                <span class="n">web3_l2</span><span class="p">,</span>
                <span class="n">private_key</span><span class="p">,</span>
                <span class="n">l2_token_addr</span><span class="p">,</span>
                <span class="n">SCROLL_L2_GATEWAY_ROUTER_ADDRESS</span><span class="p">,</span>
                <span class="n">amount</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Approval for L2 ERC20 withdrawal successful.&quot;</span><span class="p">)</span>

            <span class="c1"># Balance check (already done by _approve_erc20_scroll if it were to fail early, but good to have)</span>
            <span class="n">token_contract_l2</span> <span class="o">=</span> <span class="n">_get_contract_scroll</span><span class="p">(</span>
                <span class="n">web3_l2</span><span class="p">,</span> <span class="n">ERC20_ABI_NAME</span><span class="p">,</span> <span class="n">l2_token_addr</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">token_contract_l2</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">sender</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">amount</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">InsufficientBalanceError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Insufficient </span><span class="si">{</span><span class="n">token_symbol</span><span class="si">}</span><span class="s2"> balance for withdrawal (</span><span class="si">{</span><span class="n">amount</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>

            <span class="n">tx_build_withdraw_erc20_params</span><span class="p">:</span> <span class="n">TxParams</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="n">sender</span><span class="p">,</span>
                <span class="s2">&quot;to&quot;</span><span class="p">:</span> <span class="n">SCROLL_L2_GATEWAY_ROUTER_ADDRESS</span><span class="p">,</span>  <span class="c1"># Added &#39;to&#39;</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">Wei</span><span class="p">(</span>
                    <span class="mi">0</span>
                <span class="p">),</span>  <span class="c1"># No ETH sent with ERC20 withdrawal function call itself</span>
                <span class="c1"># gasPrice, nonce, gas handled by _build_and_send_tx_scroll</span>
            <span class="p">}</span>
            <span class="c1"># withdrawERC20(address _token, address _to, uint256 _amount, uint256 _gasLimit)</span>
            <span class="c1"># ABI check for L2GatewayRouter.json withdrawERC20:</span>
            <span class="c1"># { &quot;inputs&quot;: [ { &quot;internalType&quot;: &quot;address&quot;, &quot;name&quot;: &quot;token&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;internalType&quot;: &quot;address&quot;, &quot;name&quot;: &quot;to&quot;, &quot;type&quot;: &quot;address&quot; }, { &quot;internalType&quot;: &quot;uint256&quot;, &quot;name&quot;: &quot;amount&quot;, &quot;type&quot;: &quot;uint256&quot; }, { &quot;internalType&quot;: &quot;uint256&quot;, &quot;name&quot;: &quot;gasLimit&quot;, &quot;type&quot;: &quot;uint256&quot; } ], &quot;name&quot;: &quot;withdrawERC20&quot;, &quot;outputs&quot;: [], &quot;stateMutability&quot;: &quot;nonpayable&quot;, &quot;type&quot;: &quot;function&quot; }</span>
            <span class="c1"># Correct.</span>
            <span class="n">withdraw_erc20_fn</span> <span class="o">=</span> <span class="n">l2_router</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">withdrawERC20</span><span class="p">(</span>
                <span class="n">l2_token_addr</span><span class="p">,</span> <span class="n">to_addr</span><span class="p">,</span> <span class="n">amount</span><span class="p">,</span> <span class="n">l1_execution_gas_limit</span>
            <span class="p">)</span>
            <span class="n">tx</span> <span class="o">=</span> <span class="n">withdraw_erc20_fn</span><span class="o">.</span><span class="n">build_transaction</span><span class="p">(</span><span class="n">tx_build_withdraw_erc20_params</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">_build_and_send_tx_scroll</span><span class="p">(</span><span class="n">web3_l2</span><span class="p">,</span> <span class="n">private_key</span><span class="p">,</span> <span class="n">tx</span><span class="p">)</span></div>


<span class="c1"># --- Random Activity Orchestration Functions ---</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_select_random_scroll_action</span><span class="p">(</span><span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Select a random action from the available Scroll actions based on weights.</span>

<span class="sd">    Args:</span>
<span class="sd">        config: Configuration dictionary containing action weights.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Selected action name.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ScrollRandomActivityError: If action weights are invalid or missing.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; config = {&quot;action_weights&quot;: {&quot;bridge_assets&quot;: 0.3, &quot;swap_tokens&quot;: 0.7}}</span>
<span class="sd">        &gt;&gt;&gt; action = _select_random_scroll_action(config)</span>
<span class="sd">        &gt;&gt;&gt; action in [&quot;bridge_assets&quot;, &quot;swap_tokens&quot;]</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">action_weights</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action_weights&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="c1"># Default uniform weights if not provided</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">action_weights</span><span class="p">:</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;bridge_assets&quot;</span><span class="p">,</span> <span class="s2">&quot;swap_tokens&quot;</span><span class="p">,</span> <span class="s2">&quot;provide_liquidity_scroll&quot;</span><span class="p">,</span> <span class="s2">&quot;lend_borrow_layerbank_scroll&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">actions</span><span class="p">)</span>

        <span class="c1"># Validate weights</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">action_weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">action_weights</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">actions</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScrollRandomActivityError</span><span class="p">(</span><span class="s2">&quot;Invalid action weights: weights must be positive and sum &gt; 0&quot;</span><span class="p">)</span>

        <span class="c1"># Use random.choices for weighted selection</span>
        <span class="n">selected_action</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">actions</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Selected random action: </span><span class="si">{</span><span class="n">selected_action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">selected_action</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to select random action: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ScrollRandomActivityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Action selection failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_get_wallet_balances_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">token_symbols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="n">token_configs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get wallet balances for specified tokens on Scroll L2.</span>

<span class="sd">    Args:</span>
<span class="sd">        web3_scroll: Web3 instance for Scroll L2.</span>
<span class="sd">        address: Wallet address to check.</span>
<span class="sd">        token_symbols: List of token symbols to check.</span>
<span class="sd">        token_configs: Token configuration mapping.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary mapping token symbols to balances in smallest units.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; balances = _get_wallet_balances_scroll(web3, address, [&quot;ETH&quot;, &quot;USDC&quot;], configs)</span>
<span class="sd">        &gt;&gt;&gt; &quot;ETH&quot; in balances and &quot;USDC&quot; in balances</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">balances</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">symbol</span> <span class="ow">in</span> <span class="n">token_symbols</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
                <span class="n">balance</span> <span class="o">=</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
                <span class="n">balances</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">token_address</span> <span class="o">=</span> <span class="n">_get_l2_token_address_scroll</span><span class="p">(</span><span class="n">symbol</span><span class="p">)</span>
                <span class="n">token_contract</span> <span class="o">=</span> <span class="n">_get_contract_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">ERC20_ABI_NAME</span><span class="p">,</span> <span class="n">token_address</span><span class="p">)</span>
                <span class="n">balance</span> <span class="o">=</span> <span class="n">token_contract</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">balanceOf</span><span class="p">(</span><span class="n">address</span><span class="p">)</span><span class="o">.</span><span class="n">call</span><span class="p">()</span>
                <span class="n">balances</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get balance for </span><span class="si">{</span><span class="n">symbol</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">balances</span><span class="p">[</span><span class="n">symbol</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">balances</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_generate_params_for_scroll_action</span><span class="p">(</span>
    <span class="n">action_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">web3_l1</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">user_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">activity_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
    <span class="n">scroll_token_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate parameters for a specific Scroll action based on configuration.</span>

<span class="sd">    Args:</span>
<span class="sd">        action_name: Name of the action to generate parameters for.</span>
<span class="sd">        web3_l1: Web3 instance for L1.</span>
<span class="sd">        web3_scroll: Web3 instance for Scroll L2.</span>
<span class="sd">        private_key: User&#39;s private key.</span>
<span class="sd">        user_address: User&#39;s wallet address.</span>
<span class="sd">        activity_config: Random activity configuration.</span>
<span class="sd">        scroll_token_config: Token configuration.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary of parameters for the action.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ScrollRandomActivityError: If parameter generation fails.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; params = _generate_params_for_scroll_action(&quot;swap_tokens&quot;, web3_l1, web3_scroll, key, addr, config, tokens)</span>
<span class="sd">        &gt;&gt;&gt; &quot;token_in_symbol&quot; in params and &quot;token_out_symbol&quot; in params</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">action_config</span> <span class="o">=</span> <span class="n">activity_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">action_name</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">if</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s2">&quot;bridge_assets&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_generate_bridge_params_scroll</span><span class="p">(</span><span class="n">web3_l1</span><span class="p">,</span> <span class="n">web3_scroll</span><span class="p">,</span> <span class="n">user_address</span><span class="p">,</span> <span class="n">action_config</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s2">&quot;swap_tokens&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_generate_swap_params_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">user_address</span><span class="p">,</span> <span class="n">action_config</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s2">&quot;provide_liquidity_scroll&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_generate_liquidity_params_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">user_address</span><span class="p">,</span> <span class="n">action_config</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">action_name</span> <span class="o">==</span> <span class="s2">&quot;lend_borrow_layerbank_scroll&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_generate_lending_params_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">user_address</span><span class="p">,</span> <span class="n">action_config</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ScrollRandomActivityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown action: </span><span class="si">{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to generate parameters for </span><span class="si">{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">ScrollRandomActivityError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter generation failed for </span><span class="si">{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_generate_bridge_params_scroll</span><span class="p">(</span>
    <span class="n">web3_l1</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">user_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate parameters for bridge_assets action.&quot;&quot;&quot;</span>
    <span class="n">directions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;directions&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;deposit&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;withdraw&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)])</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tokens_l1_l2&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;ETH&quot;</span><span class="p">,</span> <span class="s2">&quot;USDC&quot;</span><span class="p">])</span>

    <span class="c1"># Select direction and token</span>
    <span class="n">direction_choices</span><span class="p">,</span> <span class="n">direction_weights</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">directions</span><span class="p">)</span> <span class="k">if</span> <span class="n">directions</span> <span class="k">else</span> <span class="p">([</span><span class="s2">&quot;deposit&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">direction_choices</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">direction_weights</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">token_symbol</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

    <span class="c1"># Get balances to determine realistic amounts</span>
    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;deposit&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="n">web3_l1</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">user_address</span><span class="p">))</span>
            <span class="n">amount_range</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amount_eth_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For ERC20 tokens, we&#39;d need to check L1 balance</span>
            <span class="n">amount_range</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amount_usdc_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="n">Wei</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">amount_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span>  <span class="c1"># Assume sufficient for demo</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># withdraw</span>
        <span class="k">if</span> <span class="n">token_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="n">web3_scroll</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">get_balance</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">to_checksum_address</span><span class="p">(</span><span class="n">user_address</span><span class="p">))</span>
            <span class="n">amount_range</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amount_eth_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Check L2 balance</span>
            <span class="n">amount_range</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amount_usdc_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
            <span class="n">balance</span> <span class="o">=</span> <span class="n">Wei</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">amount_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">))</span>  <span class="c1"># Assume sufficient for demo</span>

    <span class="c1"># Generate amount within range and balance constraints</span>
    <span class="k">if</span> <span class="n">token_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
        <span class="n">min_amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">18</span><span class="p">)</span>
        <span class="n">max_amount</span> <span class="o">=</span> <span class="n">Wei</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">amount_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">18</span><span class="p">,</span> <span class="n">balance</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)))</span>  <span class="c1"># Use 80% of balance max</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">amount_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">)</span>  <span class="c1"># USDC has 6 decimals</span>
        <span class="n">max_amount</span> <span class="o">=</span> <span class="n">Wei</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">amount_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span> <span class="n">balance</span> <span class="o">*</span> <span class="mf">0.8</span><span class="p">)))</span>

    <span class="n">amount</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">min_amount</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">min_amount</span><span class="p">,</span> <span class="n">max_amount</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;web3_l1&quot;</span><span class="p">:</span> <span class="n">web3_l1</span><span class="p">,</span>
        <span class="s2">&quot;web3_l2&quot;</span><span class="p">:</span> <span class="n">web3_scroll</span><span class="p">,</span>
        <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="n">direction</span><span class="p">,</span>
        <span class="s2">&quot;token_symbol&quot;</span><span class="p">:</span> <span class="n">token_symbol</span><span class="p">,</span>
        <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
        <span class="s2">&quot;recipient_address&quot;</span><span class="p">:</span> <span class="n">user_address</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_generate_swap_params_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">user_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate parameters for swap_tokens action.&quot;&quot;&quot;</span>
    <span class="n">token_pairs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_pairs&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;ETH&quot;</span><span class="p">,</span> <span class="s2">&quot;USDC&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)])</span>
    <span class="n">slippage</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;slippage_percent&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Select token pair</span>
    <span class="k">if</span> <span class="n">token_pairs</span><span class="p">:</span>
        <span class="n">pair_choices</span> <span class="o">=</span> <span class="p">[(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">token_pairs</span><span class="p">]</span>
        <span class="n">pair_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">token_pairs</span><span class="p">]</span>
        <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">pair_choices</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">pair_weights</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token_in</span><span class="p">,</span> <span class="n">token_out</span> <span class="o">=</span> <span class="s2">&quot;ETH&quot;</span><span class="p">,</span> <span class="s2">&quot;USDC&quot;</span>

    <span class="c1"># Get balance and determine amount</span>
    <span class="n">balances</span> <span class="o">=</span> <span class="n">_get_wallet_balances_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">user_address</span><span class="p">,</span> <span class="p">[</span><span class="n">token_in</span><span class="p">],</span> <span class="p">{})</span>
    <span class="n">balance</span> <span class="o">=</span> <span class="n">balances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token_in</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">token_in</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
        <span class="n">percent_range</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amount_eth_percent_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">15</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">percent_range</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;amount_usdc_percent_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">30</span><span class="p">])</span>

    <span class="n">percent</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">percent_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">percent_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">balance</span> <span class="o">*</span> <span class="n">percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;web3_scroll&quot;</span><span class="p">:</span> <span class="n">web3_scroll</span><span class="p">,</span>
        <span class="s2">&quot;token_in_symbol&quot;</span><span class="p">:</span> <span class="n">token_in</span><span class="p">,</span>
        <span class="s2">&quot;token_out_symbol&quot;</span><span class="p">:</span> <span class="n">token_out</span><span class="p">,</span>
        <span class="s2">&quot;amount_in&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>  <span class="c1"># Ensure non-zero</span>
        <span class="s2">&quot;slippage_percent&quot;</span><span class="p">:</span> <span class="n">slippage</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_generate_liquidity_params_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">user_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate parameters for provide_liquidity_scroll action.&quot;&quot;&quot;</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;actions&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;remove&quot;</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)])</span>
    <span class="n">token_pairs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_pairs&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;ETH&quot;</span><span class="p">,</span> <span class="s2">&quot;USDC&quot;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)])</span>
    <span class="n">slippage</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;slippage_percent&quot;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Select action and token pair</span>
    <span class="n">action_choices</span><span class="p">,</span> <span class="n">action_weights</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">actions</span><span class="p">)</span> <span class="k">if</span> <span class="n">actions</span> <span class="k">else</span> <span class="p">([</span><span class="s2">&quot;add&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">action_choices</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">action_weights</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">token_pairs</span><span class="p">:</span>
        <span class="n">pair_choices</span> <span class="o">=</span> <span class="p">[(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">token_pairs</span><span class="p">]</span>
        <span class="n">pair_weights</span> <span class="o">=</span> <span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">else</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">token_pairs</span><span class="p">]</span>
        <span class="n">token_a</span><span class="p">,</span> <span class="n">token_b</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="n">pair_choices</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">pair_weights</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token_a</span><span class="p">,</span> <span class="n">token_b</span> <span class="o">=</span> <span class="s2">&quot;ETH&quot;</span><span class="p">,</span> <span class="s2">&quot;USDC&quot;</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;web3_scroll&quot;</span><span class="p">:</span> <span class="n">web3_scroll</span><span class="p">,</span>
        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
        <span class="s2">&quot;token_a_symbol&quot;</span><span class="p">:</span> <span class="n">token_a</span><span class="p">,</span>
        <span class="s2">&quot;token_b_symbol&quot;</span><span class="p">:</span> <span class="n">token_b</span><span class="p">,</span>
        <span class="s2">&quot;slippage_percent&quot;</span><span class="p">:</span> <span class="n">slippage</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
        <span class="c1"># Get balances and calculate amounts</span>
        <span class="n">balances</span> <span class="o">=</span> <span class="n">_get_wallet_balances_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">user_address</span><span class="p">,</span> <span class="p">[</span><span class="n">token_a</span><span class="p">,</span> <span class="n">token_b</span><span class="p">],</span> <span class="p">{})</span>

        <span class="n">eth_percent_range</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_amount_eth_percent_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
        <span class="n">usdc_percent_range</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_amount_usdc_percent_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">token_a</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
            <span class="n">percent_a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">eth_percent_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eth_percent_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">percent_a</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">usdc_percent_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">usdc_percent_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">token_b</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
            <span class="n">percent_b</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">eth_percent_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">eth_percent_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">percent_b</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">usdc_percent_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">usdc_percent_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">amount_a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">balances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token_a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">percent_a</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="n">amount_b</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">balances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token_b</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="n">percent_b</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>

        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s2">&quot;amount_a_desired&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">amount_a</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="s2">&quot;amount_b_desired&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">amount_b</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># remove</span>
        <span class="c1"># For remove, we need LP token amount - simplified for demo</span>
        <span class="n">lp_percent_range</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;remove_lp_percent_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">])</span>
        <span class="n">percent</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lp_percent_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lp_percent_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># In real implementation, would fetch actual LP balance</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;lp_token_amount&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="mi">18</span> <span class="o">*</span> <span class="n">percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>  <span class="c1"># Demo value</span>

    <span class="k">return</span> <span class="n">params</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_generate_lending_params_scroll</span><span class="p">(</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">user_address</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate parameters for lend_borrow_layerbank_scroll action.&quot;&quot;&quot;</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;actions&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;lend&quot;</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;borrow&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;repay&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;withdraw&quot;</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">)])</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tokens&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;ETH&quot;</span><span class="p">,</span> <span class="s2">&quot;USDC&quot;</span><span class="p">])</span>

    <span class="c1"># Select action and token</span>
    <span class="n">action_choices</span><span class="p">,</span> <span class="n">action_weights</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">actions</span><span class="p">)</span> <span class="k">if</span> <span class="n">actions</span> <span class="k">else</span> <span class="p">([</span><span class="s2">&quot;lend&quot;</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">])</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choices</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">action_choices</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">action_weights</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">token_symbol</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>

    <span class="c1"># Get balance for amount calculation</span>
    <span class="n">balances</span> <span class="o">=</span> <span class="n">_get_wallet_balances_scroll</span><span class="p">(</span><span class="n">web3_scroll</span><span class="p">,</span> <span class="n">user_address</span><span class="p">,</span> <span class="p">[</span><span class="n">token_symbol</span><span class="p">],</span> <span class="p">{})</span>
    <span class="n">balance</span> <span class="o">=</span> <span class="n">balances</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">token_symbol</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;lend&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">token_symbol</span> <span class="o">==</span> <span class="n">ETH_SYMBOL</span><span class="p">:</span>
            <span class="n">percent_range</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lend_amount_eth_percent_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">percent_range</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lend_amount_usdc_percent_range&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">])</span>
        <span class="n">percent</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">percent_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">percent_range</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">balance</span> <span class="o">*</span> <span class="n">percent</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># For borrow/repay/withdraw, would need to check LayerBank positions</span>
        <span class="c1"># Simplified for demo</span>
        <span class="n">amount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">balance</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>  <span class="c1"># Use 10% as demo</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;web3_scroll&quot;</span><span class="p">:</span> <span class="n">web3_scroll</span><span class="p">,</span>
        <span class="s2">&quot;action&quot;</span><span class="p">:</span> <span class="n">action</span><span class="p">,</span>
        <span class="s2">&quot;token_symbol&quot;</span><span class="p">:</span> <span class="n">token_symbol</span><span class="p">,</span>
        <span class="s2">&quot;amount&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">amount</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="p">}</span>


<div class="viewcode-block" id="perform_random_activity_scroll">
<a class="viewcode-back" href="../../../../protocols.html#airdrops.protocols.scroll.scroll.perform_random_activity_scroll">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">perform_random_activity_scroll</span><span class="p">(</span>
    <span class="n">web3_l1</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">web3_scroll</span><span class="p">:</span> <span class="n">Web3</span><span class="p">,</span>
    <span class="n">private_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">action_count</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a random sequence of actions on the Scroll network.</span>

<span class="sd">    Args:</span>
<span class="sd">        web3_l1: Web3 instance for L1 (Ethereum).</span>
<span class="sd">        web3_scroll: Web3 instance for Scroll L2.</span>
<span class="sd">        private_key: Private key of the account performing actions.</span>
<span class="sd">        action_count: The number of random actions to perform (e.g., 1 to N).</span>
<span class="sd">        config: Configuration dictionary. Expected to contain</span>
<span class="sd">                a &#39;random_activity_scroll&#39; key with specific</span>
<span class="sd">                configurations for this function, including</span>
<span class="sd">                parameters for sub-actions.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Tuple[bool, Union[List[str], str]]: A tuple where the first element is a boolean</span>
<span class="sd">                                            indicating overall success (True if all actions</span>
<span class="sd">                                            were attempted according to stop_on_failure policy,</span>
<span class="sd">                                            False if a critical setup error occurred).</span>
<span class="sd">                                            The second element is a list of transaction hashes</span>
<span class="sd">                                            for successful actions, or an error message string</span>
<span class="sd">                                            if the process failed catastrophically before any actions.</span>
<span class="sd">                                            Individual action failures within a sequence will be logged.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ScrollRandomActivityError: For orchestration-specific errors.</span>
<span class="sd">        ValueError: For invalid input parameters.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; config = {</span>
<span class="sd">        ...     &quot;random_activity_scroll&quot;: {</span>
<span class="sd">        ...         &quot;action_weights&quot;: {&quot;swap_tokens&quot;: 1.0},</span>
<span class="sd">        ...         &quot;stop_on_failure&quot;: True,</span>
<span class="sd">        ...         &quot;swap_tokens&quot;: {&quot;token_pairs&quot;: [(&quot;ETH&quot;, &quot;USDC&quot;, 1.0)]}</span>
<span class="sd">        ...     }</span>
<span class="sd">        ... }</span>
<span class="sd">        &gt;&gt;&gt; success, result = perform_random_activity_scroll(web3_l1, web3_scroll, key, 1, config)</span>
<span class="sd">        &gt;&gt;&gt; isinstance(success, bool)</span>
<span class="sd">        True</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting random activity sequence with </span><span class="si">{</span><span class="n">action_count</span><span class="si">}</span><span class="s2"> actions&quot;</span><span class="p">)</span>

    <span class="c1"># Validate inputs</span>
    <span class="k">if</span> <span class="n">action_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;action_count must be positive&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span> <span class="ow">or</span> <span class="s2">&quot;random_activity_scroll&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">config</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ScrollRandomActivityError</span><span class="p">(</span><span class="s2">&quot;Missing &#39;random_activity_scroll&#39; configuration&quot;</span><span class="p">)</span>

    <span class="n">activity_config</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s2">&quot;random_activity_scroll&quot;</span><span class="p">]</span>
    <span class="n">stop_on_failure</span> <span class="o">=</span> <span class="n">activity_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stop_on_failure&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">inter_action_delay_range</span> <span class="o">=</span> <span class="n">activity_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inter_action_delay_seconds_range&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="c1"># Validate action weights early to catch configuration errors</span>
    <span class="n">action_weights</span> <span class="o">=</span> <span class="n">activity_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action_weights&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">action_weights</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ScrollRandomActivityError</span><span class="p">(</span><span class="s2">&quot;Missing &#39;action_weights&#39; in configuration&quot;</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">action_weights</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">weights</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ScrollRandomActivityError</span><span class="p">(</span><span class="s2">&quot;Invalid action weights: weights must be positive and sum &gt; 0&quot;</span><span class="p">)</span>

    <span class="c1"># Get user address</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">account</span> <span class="o">=</span> <span class="n">_get_account_scroll</span><span class="p">(</span><span class="n">private_key</span><span class="p">,</span> <span class="n">web3_scroll</span><span class="p">)</span>
        <span class="n">user_address</span> <span class="o">=</span> <span class="n">account</span><span class="o">.</span><span class="n">address</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to get account from private key: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>

    <span class="c1"># Action dispatch mapping</span>
    <span class="n">action_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;bridge_assets&quot;</span><span class="p">:</span> <span class="n">bridge_assets</span><span class="p">,</span>
        <span class="s2">&quot;swap_tokens&quot;</span><span class="p">:</span> <span class="n">swap_tokens</span><span class="p">,</span>
        <span class="s2">&quot;provide_liquidity_scroll&quot;</span><span class="p">:</span> <span class="n">provide_liquidity_scroll</span><span class="p">,</span>
        <span class="s2">&quot;lend_borrow_layerbank_scroll&quot;</span><span class="p">:</span> <span class="n">lend_borrow_layerbank_scroll</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">successful_tx_hashes</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">action_count</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing action </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">action_count</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># Select random action</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">selected_action</span> <span class="o">=</span> <span class="n">_select_random_scroll_action</span><span class="p">(</span><span class="n">activity_config</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ScrollRandomActivityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="c1"># For ScrollRandomActivityError during execution, return error tuple</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to select action </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stop_on_failure</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
                <span class="k">continue</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to select action </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stop_on_failure</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
                <span class="k">continue</span>

            <span class="c1"># Generate parameters for the action</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">action_params</span> <span class="o">=</span> <span class="n">_generate_params_for_scroll_action</span><span class="p">(</span>
                    <span class="n">selected_action</span><span class="p">,</span>
                    <span class="n">web3_l1</span><span class="p">,</span>
                    <span class="n">web3_scroll</span><span class="p">,</span>
                    <span class="n">private_key</span><span class="p">,</span>
                    <span class="n">user_address</span><span class="p">,</span>
                    <span class="n">activity_config</span><span class="p">,</span>
                    <span class="n">shared_config</span><span class="o">.</span><span class="n">SCROLL_TOKEN_ADDRESSES</span>
                <span class="p">)</span>
                <span class="c1"># Add private_key to params</span>
                <span class="n">action_params</span><span class="p">[</span><span class="s2">&quot;private_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">private_key</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to generate parameters for </span><span class="si">{</span><span class="n">selected_action</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stop_on_failure</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">error_msg</span>
                <span class="k">continue</span>

            <span class="c1"># Execute the action</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">action_function</span> <span class="o">=</span> <span class="n">action_map</span><span class="p">[</span><span class="n">selected_action</span><span class="p">]</span>
                <span class="n">tx_hash</span> <span class="o">=</span> <span class="n">action_function</span><span class="p">(</span><span class="o">**</span><span class="n">action_params</span><span class="p">)</span>  <span class="c1"># type: ignore[operator]</span>
                <span class="n">successful_tx_hashes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Action </span><span class="si">{</span><span class="n">selected_action</span><span class="si">}</span><span class="s2"> completed successfully: </span><span class="si">{</span><span class="n">tx_hash</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Action </span><span class="si">{</span><span class="n">selected_action</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stop_on_failure</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">successful_tx_hashes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">successful_tx_hashes</span> <span class="k">if</span> <span class="n">successful_tx_hashes</span> <span class="k">else</span> <span class="n">error_msg</span>
                <span class="c1"># Continue with next action if stop_on_failure is False</span>

            <span class="c1"># Inter-action delay</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">action_count</span> <span class="o">-</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">inter_action_delay_range</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">inter_action_delay_range</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
                    <span class="n">inter_action_delay_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inter_action_delay_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Waiting </span><span class="si">{</span><span class="n">delay</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> seconds before next action&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Random activity sequence completed. Successful transactions: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">successful_tx_hashes</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">successful_tx_hashes</span>

    <span class="k">except</span> <span class="n">ScrollRandomActivityError</span><span class="p">:</span>
        <span class="c1"># Re-raise ScrollRandomActivityError to preserve specific error type</span>
        <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Unexpected error during random activity execution: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="kc">False</span><span class="p">,</span>
            <span class="n">successful_tx_hashes</span> <span class="k">if</span> <span class="n">successful_tx_hashes</span> <span class="k">else</span> <span class="n">error_msg</span>
        <span class="p">)</span></div>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;bridge_assets&quot;</span><span class="p">,</span>
    <span class="s2">&quot;swap_tokens&quot;</span><span class="p">,</span>
    <span class="s2">&quot;provide_liquidity_scroll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;lend_borrow_layerbank_scroll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;perform_random_activity_scroll&quot;</span><span class="p">,</span>
    <span class="c1"># Exposing some helpers for potential direct use or testing, though mostly internal</span>
    <span class="s2">&quot;_get_account_scroll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_get_l2_token_address_scroll&quot;</span><span class="p">,</span>  <span class="c1"># New helper</span>
    <span class="s2">&quot;_get_contract_scroll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_estimate_l1_to_l2_message_fee_scroll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_approve_erc20_scroll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_build_and_send_tx_scroll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_get_layerbank_lbtoken_address_scroll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_check_and_enter_layerbank_market_scroll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_get_layerbank_account_liquidity_scroll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_select_random_scroll_action&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_get_wallet_balances_scroll&quot;</span><span class="p">,</span>
    <span class="s2">&quot;_generate_params_for_scroll_action&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="c1"># Expose helpers for test patching if needed by existing tests, or for new tests</span>
<span class="c1"># globals()[&quot;_get_token_addresses_scroll&quot;] = _get_token_addresses_scroll</span>
<span class="c1"># Old one, replaced by _get_l2_token_address_scroll</span>
<span class="c1"># Keep existing globals for bridge_assets tests if they rely on them.</span>
<span class="c1"># The task is to add swap_tokens, so focus on new functionality&#39;s exposure.</span>
<span class="c1"># For now, only add new functions to __all__ and let tests adapt if they were</span>
<span class="c1"># patching internal details.</span>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Airdrops Automation Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>